CREATE TABLE CONTRATOS_ARRENDAMIENTOS (
            ID_CONTRATO_A INTEGER PRIMARY KEY AUTOINCREMENT,
            ID_PROPIEDAD INTEGER NOT NULL,
            ID_ARRENDATARIO INTEGER NOT NULL,
            ID_CODEUDOR INTEGER,
            FECHA_INICIO_CONTRATO_A TEXT NOT NULL,
            FECHA_FIN_CONTRATO_A TEXT NOT NULL,
            DURACION_CONTRATO_A INTEGER NOT NULL CHECK(DURACION_CONTRATO_A > 0),
            CANON_ARRENDAMIENTO INTEGER NOT NULL CHECK(CANON_ARRENDAMIENTO >= 500000 AND CANON_ARRENDAMIENTO <= 200000000),
            DEPOSITO INTEGER DEFAULT 0 CHECK(DEPOSITO >= 0),
            ESTADO_CONTRATO_A TEXT CHECK(ESTADO_CONTRATO_A IN ('Activo', 'Finalizado', 'Legal', 'Cancelado')) DEFAULT 'Activo',
            MOTIVO_CANCELACION TEXT,
            ALERTA_VENCIMIENTO_CONTRATO_A INTEGER DEFAULT 1 CHECK(ALERTA_VENCIMIENTO_CONTRATO_A IN (0, 1)),
            ALERTA_IPC INTEGER DEFAULT 0 CHECK(ALERTA_IPC IN (0, 1)),
            FECHA_RENOVACION_CONTRATO_A TEXT,
            FECHA_INCREMENTO_IPC TEXT,
            FECHA_ULTIMO_INCREMENTO_IPC TEXT,
            CREATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
            CREATED_BY TEXT,
            UPDATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
            UPDATED_BY TEXT,
            CHECK(date(FECHA_FIN_CONTRATO_A) > date(FECHA_INICIO_CONTRATO_A)),
            FOREIGN KEY (ID_PROPIEDAD) REFERENCES PROPIEDADES(ID_PROPIEDAD),
            FOREIGN KEY (ID_ARRENDATARIO) REFERENCES ARRENDATARIOS(ID_ARRENDATARIO),
            FOREIGN KEY (ID_CODEUDOR) REFERENCES CODEUDORES(ID_CODEUDOR)
        );
CREATE UNIQUE INDEX idx_arriendo_activo ON CONTRATOS_ARRENDAMIENTOS(ID_PROPIEDAD) WHERE ESTADO_CONTRATO_A = 'Activo';
CREATE TRIGGER TRG_PREVENIR_DELETE_CONTRATOS
            BEFORE DELETE ON CONTRATOS_ARRENDAMIENTOS
            BEGIN
                SELECT RAISE(ABORT, 'Error: No est├í permitido eliminar contratos f├¡sicamente. Debe cambiar su estado a "Cancelado" o "Finalizado" para mantener el hist├│rico.');
            END;
CREATE TRIGGER TRG_VALIDAR_FECHAS_CONTRATO
            BEFORE INSERT ON CONTRATOS_ARRENDAMIENTOS
            BEGIN
                SELECT RAISE(ABORT, 'Error: La fecha de finalizaci├│n no puede ser anterior a la fecha de inicio.')
                WHERE NEW.FECHA_FIN_CONTRATO_A <= NEW.FECHA_INICIO_CONTRATO_A;
            END;
CREATE TRIGGER TRG_EVITAR_SOLAPAMIENTO_ARRIENDO
            BEFORE INSERT ON CONTRATOS_ARRENDAMIENTOS
            BEGIN
                SELECT RAISE(ABORT, 'Error: Esta propiedad ya tiene un contrato de arrendamiento ACTIVO. Debe finalizar el anterior primero.')
                WHERE EXISTS (
                    SELECT 1 FROM CONTRATOS_ARRENDAMIENTOS 
                    WHERE ID_PROPIEDAD = NEW.ID_PROPIEDAD 
                    AND ESTADO_CONTRATO_A = 'Activo'
                );
            END;
CREATE TRIGGER TRG_EXIGIR_MOTIVO_CANCELACION
            BEFORE UPDATE ON CONTRATOS_ARRENDAMIENTOS
            WHEN NEW.ESTADO_CONTRATO_A = 'Cancelado' 
            AND (NEW.MOTIVO_CANCELACION IS NULL OR NEW.MOTIVO_CANCELACION = '')
            BEGIN
                SELECT RAISE(ABORT, 'Error: Para cancelar un contrato es OBLIGATORIO ingresar un motivo de cancelaci├│n.');
            END;
CREATE TRIGGER TRG_ACTUALIZAR_DISPONIBILIDAD_OCUPADA
        AFTER INSERT ON CONTRATOS_ARRENDAMIENTOS
        WHEN NEW.ESTADO_CONTRATO_A = 'Activo'
        BEGIN
            UPDATE PROPIEDADES 
            SET DISPONIBILIDAD_PROPIEDAD = 0,
                UPDATED_BY = NEW.CREATED_BY,
                UPDATED_AT = datetime('now', 'localtime')
            WHERE ID_PROPIEDAD = NEW.ID_PROPIEDAD;
        END;
