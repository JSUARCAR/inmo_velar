-- ==========================================
-- BASE DE DATOS VELAR SAS - VERSIÓN FINAL CORREGIDA (10/10)
-- Sistema de Gestión Inmobiliaria Completo
-- ==========================================

PRAGMA foreign_keys = ON;
PRAGMA journal_mode = WAL;
PRAGMA synchronous = NORMAL;

-- ==========================================
-- 1. SISTEMA DE USUARIOS Y SEGURIDAD
-- ==========================================

CREATE TABLE USUARIOS (
    ID_USUARIO INTEGER PRIMARY KEY AUTOINCREMENT,
    NOMBRE_USUARIO TEXT NOT NULL UNIQUE,
    CONTRASENA_HASH TEXT NOT NULL,
    ROL TEXT NOT NULL CHECK(ROL IN ('Administrador', 'Asesor')),
    ESTADO_USUARIO INTEGER DEFAULT 1 CHECK(ESTADO_USUARIO IN (0, 1)),
    ULTIMO_ACCESO TEXT,
    FECHA_CREACION TEXT DEFAULT (datetime('now', 'localtime')),
    CREATED_BY TEXT,
    UPDATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    UPDATED_BY TEXT
);

CREATE TABLE SESIONES_USUARIO (
    ID_SESION INTEGER PRIMARY KEY AUTOINCREMENT,
    ID_USUARIO INTEGER NOT NULL,
    FECHA_INICIO TEXT DEFAULT (datetime('now', 'localtime')),
    FECHA_FIN TEXT,
    TOKEN_SESION TEXT UNIQUE,
    FOREIGN KEY (ID_USUARIO) REFERENCES USUARIOS(ID_USUARIO)
);

-- ==========================================
-- 2. TABLAS MAESTRAS Y GEOGRAFÍA
-- ==========================================

CREATE TABLE MUNICIPIOS (
    ID_MUNICIPIO INTEGER PRIMARY KEY AUTOINCREMENT,
    NOMBRE_MUNICIPIO TEXT NOT NULL,
    DEPARTAMENTO TEXT NOT NULL,
    ESTADO_REGISTRO INTEGER DEFAULT 1 CHECK(ESTADO_REGISTRO IN (0, 1)),
    CREATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    CREATED_BY TEXT,
    UNIQUE(NOMBRE_MUNICIPIO, DEPARTAMENTO)
);

CREATE TABLE IPC (
    ID_IPC INTEGER PRIMARY KEY AUTOINCREMENT,
    ANIO INTEGER UNIQUE NOT NULL,
    VALOR_IPC INTEGER NOT NULL CHECK(VALOR_IPC >= 0 AND VALOR_IPC <= 10000),
    FECHA_PUBLICACION TEXT,
    ESTADO_REGISTRO INTEGER DEFAULT 1 CHECK(ESTADO_REGISTRO IN (0, 1)),
    CREATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    CREATED_BY TEXT
);

-- ==========================================
-- 3. PARTY MODEL (PERSONAS)
-- ==========================================

CREATE TABLE PERSONAS (
    ID_PERSONA INTEGER PRIMARY KEY AUTOINCREMENT,
    TIPO_DOCUMENTO TEXT CHECK(TIPO_DOCUMENTO IN ('CC', 'CE', 'NIT', 'PASAPORTE')) DEFAULT 'CC',
    NUMERO_DOCUMENTO TEXT NOT NULL,
    NOMBRE_COMPLETO TEXT NOT NULL,
    TELEFONO_PRINCIPAL TEXT,
    CORREO_ELECTRONICO TEXT,
    DIRECCION_PRINCIPAL TEXT,
    ESTADO_REGISTRO INTEGER DEFAULT 1 CHECK(ESTADO_REGISTRO IN (0, 1)),
    MOTIVO_INACTIVACION TEXT,
    CREATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    CREATED_BY TEXT,
    UPDATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    UPDATED_BY TEXT,
    UNIQUE(TIPO_DOCUMENTO, NUMERO_DOCUMENTO)
);

-- ==========================================
-- 4. ROLES
-- ==========================================

CREATE TABLE ASESORES (
    ID_ASESOR INTEGER PRIMARY KEY AUTOINCREMENT,
    ID_PERSONA INTEGER NOT NULL UNIQUE,
    ID_USUARIO INTEGER UNIQUE,
    COMISION_PORCENTAJE_ARRIENDO INTEGER NOT NULL DEFAULT 800 CHECK(COMISION_PORCENTAJE_ARRIENDO >= 0 AND COMISION_PORCENTAJE_ARRIENDO <= 10000),
    COMISION_PORCENTAJE_VENTA INTEGER NOT NULL DEFAULT 300 CHECK(COMISION_PORCENTAJE_VENTA >= 0 AND COMISION_PORCENTAJE_VENTA <= 10000),
    FECHA_INGRESO TEXT DEFAULT (date('now')),
    ESTADO INTEGER DEFAULT 1 CHECK(ESTADO IN (0, 1)),
    MOTIVO_INACTIVACION TEXT,
    CREATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    CREATED_BY TEXT,
    UPDATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    UPDATED_BY TEXT,
    FOREIGN KEY (ID_PERSONA) REFERENCES PERSONAS(ID_PERSONA),
    FOREIGN KEY (ID_USUARIO) REFERENCES USUARIOS(ID_USUARIO)
);

CREATE TABLE PROPIETARIOS (
    ID_PROPIETARIO INTEGER PRIMARY KEY AUTOINCREMENT,
    ID_PERSONA INTEGER NOT NULL UNIQUE,
    BANCO_PROPIETARIO TEXT,
    NUMERO_CUENTA_PROPIETARIO TEXT,
    TIPO_CUENTA TEXT CHECK(TIPO_CUENTA IN ('Ahorros', 'Corriente')),
    OBSERVACIONES_PROPIETARIO TEXT,
    ESTADO_PROPIETARIO INTEGER DEFAULT 1 CHECK(ESTADO_PROPIETARIO IN (0, 1)),
    FECHA_INGRESO_PROPIETARIO TEXT DEFAULT (date('now')),
    MOTIVO_INACTIVACION TEXT,
    CREATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    CREATED_BY TEXT,
    UPDATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    UPDATED_BY TEXT,
    FOREIGN KEY (ID_PERSONA) REFERENCES PERSONAS(ID_PERSONA)
);

CREATE TABLE SEGUROS (
    ID_SEGURO INTEGER PRIMARY KEY AUTOINCREMENT,
    NOMBRE_SEGURO TEXT NOT NULL UNIQUE,
    FECHA_INICIO_SEGURO TEXT,
    PORCENTAJE_SEGURO INTEGER NOT NULL DEFAULT 200 CHECK(PORCENTAJE_SEGURO >= 0 AND PORCENTAJE_SEGURO <= 10000),
    ESTADO_SEGURO INTEGER DEFAULT 1 CHECK(ESTADO_SEGURO IN (0, 1)),
    FECHA_INGRESO_SEGURO TEXT DEFAULT (date('now')),
    MOTIVO_INACTIVACION TEXT,
    CREATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    CREATED_BY TEXT,
    UPDATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    UPDATED_BY TEXT
);

CREATE TABLE ARRENDATARIOS (
    ID_ARRENDATARIO INTEGER PRIMARY KEY AUTOINCREMENT,
    ID_PERSONA INTEGER NOT NULL UNIQUE,
    ID_SEGURO INTEGER,
    CODIGO_APROBACION_SEGURO TEXT,
    DIRECCION_REFERENCIA TEXT,
    ESTADO_ARRENDATARIO INTEGER DEFAULT 1 CHECK(ESTADO_ARRENDATARIO IN (0, 1)),
    FECHA_INGRESO_ARRENDATARIO TEXT DEFAULT (date('now')),
    MOTIVO_INACTIVACION TEXT,
    CREATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    CREATED_BY TEXT,
    UPDATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    UPDATED_BY TEXT,
    FOREIGN KEY (ID_PERSONA) REFERENCES PERSONAS(ID_PERSONA),
    FOREIGN KEY (ID_SEGURO) REFERENCES SEGUROS(ID_SEGURO)
);

CREATE TABLE CODEUDORES (
    ID_CODEUDOR INTEGER PRIMARY KEY AUTOINCREMENT,
    ID_PERSONA INTEGER NOT NULL UNIQUE,
    FECHA_INGRESO_CODEUDOR TEXT DEFAULT (date('now')),
    ESTADO_REGISTRO INTEGER DEFAULT 1 CHECK(ESTADO_REGISTRO IN (0, 1)),
    MOTIVO_INACTIVACION TEXT,
    CREATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    CREATED_BY TEXT,
    FOREIGN KEY (ID_PERSONA) REFERENCES PERSONAS(ID_PERSONA)
);

-- ==========================================
-- 5. INMUEBLES (CORREGIDO)
-- ==========================================

CREATE TABLE PROPIEDADES (
    ID_PROPIEDAD INTEGER PRIMARY KEY AUTOINCREMENT,
    MATRICULA_INMOBILIARIA TEXT NOT NULL UNIQUE,
    ID_MUNICIPIO INTEGER NOT NULL,
    DIRECCION_PROPIEDAD TEXT NOT NULL,
    TIPO_PROPIEDAD TEXT NOT NULL,
    DISPONIBILIDAD_PROPIEDAD INTEGER DEFAULT 1 CHECK(DISPONIBILIDAD_PROPIEDAD IN (0, 1)),
    AREA_M2 REAL NOT NULL CHECK(AREA_M2 > 0),
    HABITACIONES INTEGER DEFAULT 0 CHECK(HABITACIONES >= 0),
    BANO INTEGER DEFAULT 0 CHECK(BANO >= 0),
    PARQUEADERO INTEGER DEFAULT 0 CHECK(PARQUEADERO >= 0),
    ESTRATO INTEGER CHECK(ESTRATO BETWEEN 1 AND 6),
    VALOR_ADMINISTRACION INTEGER DEFAULT 0 CHECK(VALOR_ADMINISTRACION >= 0),
    -- CORRECCIÓN: Se agrega columna faltante para la vista de reportes
    CANON_ARRENDAMIENTO_ESTIMADO INTEGER DEFAULT 0 CHECK(CANON_ARRENDAMIENTO_ESTIMADO >= 0),
    VALOR_VENTA_PROPIEDAD INTEGER DEFAULT 0 CHECK(VALOR_VENTA_PROPIEDAD >= 0),
    COMISION_VENTA_PROPIEDAD INTEGER DEFAULT 0 CHECK(COMISION_VENTA_PROPIEDAD >= 0),
    OBSERVACIONES_PROPIEDAD TEXT,
    FECHA_INGRESO_PROPIEDAD TEXT DEFAULT (date('now')),
    ESTADO_REGISTRO INTEGER DEFAULT 1 CHECK(ESTADO_REGISTRO IN (0, 1)),
    MOTIVO_INACTIVACION TEXT,
    CREATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    CREATED_BY TEXT,
    UPDATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    UPDATED_BY TEXT,
    FOREIGN KEY (ID_MUNICIPIO) REFERENCES MUNICIPIOS(ID_MUNICIPIO)
);

-- ==========================================
-- 6. CONTRATOS
-- ==========================================

CREATE TABLE CONTRATOS_MANDATOS (
    ID_CONTRATO_M INTEGER PRIMARY KEY AUTOINCREMENT,
    ID_PROPIEDAD INTEGER NOT NULL,
    ID_PROPIETARIO INTEGER NOT NULL,
    ID_ASESOR INTEGER NOT NULL,
    FECHA_INICIO_CONTRATO_M TEXT NOT NULL,
    FECHA_FIN_CONTRATO_M TEXT NOT NULL,
    DURACION_CONTRATO_M INTEGER NOT NULL CHECK(DURACION_CONTRATO_M > 0),
    CANON_MANDATO INTEGER NOT NULL CHECK(CANON_MANDATO >= 70000000 AND CANON_MANDATO <= 200000000),
    COMISION_PORCENTAJE_CONTRATO_M INTEGER NOT NULL CHECK(COMISION_PORCENTAJE_CONTRATO_M >= 0 AND COMISION_PORCENTAJE_CONTRATO_M <= 10000),
    IVA_CONTRATO_M INTEGER DEFAULT 1900 CHECK(IVA_CONTRATO_M >= 0),
    ESTADO_CONTRATO_M TEXT CHECK(ESTADO_CONTRATO_M IN ('Activo', 'Finalizado', 'Cancelado')) DEFAULT 'Activo',
    MOTIVO_CANCELACION TEXT,
    ALERTA_VENCIMINETO_CONTRATO_M INTEGER DEFAULT 1 CHECK(ALERTA_VENCIMINETO_CONTRATO_M IN (0, 1)),
    FECHA_RENOVACION_CONTRATO_M TEXT,
    CREATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    CREATED_BY TEXT,
    UPDATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    UPDATED_BY TEXT,
    CHECK(date(FECHA_FIN_CONTRATO_M) > date(FECHA_INICIO_CONTRATO_M)),
    FOREIGN KEY (ID_PROPIEDAD) REFERENCES PROPIEDADES(ID_PROPIEDAD),
    FOREIGN KEY (ID_PROPIETARIO) REFERENCES PROPIETARIOS(ID_PROPIETARIO),
    FOREIGN KEY (ID_ASESOR) REFERENCES ASESORES(ID_ASESOR)
);

CREATE TABLE CONTRATOS_ARRENDAMIENTOS (
    ID_CONTRATO_A INTEGER PRIMARY KEY AUTOINCREMENT,
    ID_PROPIEDAD INTEGER NOT NULL,
    ID_ARRENDATARIO INTEGER NOT NULL,
    ID_CODEUDOR INTEGER,
    FECHA_INICIO_CONTRATO_A TEXT NOT NULL,
    FECHA_FIN_CONTRATO_A TEXT NOT NULL,
    DURACION_CONTRATO_A INTEGER NOT NULL CHECK(DURACION_CONTRATO_A > 0),
    CANON_ARRENDAMIENTO INTEGER NOT NULL CHECK(CANON_ARRENDAMIENTO >= 70000000 AND CANON_ARRENDAMIENTO <= 200000000),
    DEPOSITO INTEGER DEFAULT 0 CHECK(DEPOSITO >= 0),
    ESTADO_CONTRATO_A TEXT CHECK(ESTADO_CONTRATO_A IN ('Activo', 'Finalizado', 'Legal', 'Cancelado')) DEFAULT 'Activo',
    MOTIVO_CANCELACION TEXT,
    ALERTA_VENCIMIENTO_CONTRATO_A INTEGER DEFAULT 1 CHECK(ALERTA_VENCIMIENTO_CONTRATO_A IN (0, 1)),
    ALERTA_IPC INTEGER DEFAULT 0 CHECK(ALERTA_IPC IN (0, 1)),
    FECHA_RENOVACION_CONTRATO_A TEXT,
    FECHA_INCREMENTO_IPC TEXT,
    FECHA_ULTIMO_INCREMENTO_IPC TEXT,
    CREATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    CREATED_BY TEXT,
    UPDATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    UPDATED_BY TEXT,
    CHECK(date(FECHA_FIN_CONTRATO_A) > date(FECHA_INICIO_CONTRATO_A)),
    FOREIGN KEY (ID_PROPIEDAD) REFERENCES PROPIEDADES(ID_PROPIEDAD),
    FOREIGN KEY (ID_ARRENDATARIO) REFERENCES ARRENDATARIOS(ID_ARRENDATARIO),
    FOREIGN KEY (ID_CODEUDOR) REFERENCES CODEUDORES(ID_CODEUDOR)
);

CREATE TABLE RENOVACIONES_CONTRATOS (
    ID_RENOVACION INTEGER PRIMARY KEY AUTOINCREMENT,
    ID_CONTRATO_M INTEGER,
    ID_CONTRATO_A INTEGER,
    TIPO_CONTRATO TEXT NOT NULL CHECK(TIPO_CONTRATO IN ('Mandato', 'Arrendamiento')),
    FECHA_INICIO_ORIGINAL TEXT NOT NULL,
    FECHA_FIN_ORIGINAL TEXT NOT NULL,
    FECHA_INICIO_RENOVACION TEXT NOT NULL,
    FECHA_FIN_RENOVACION TEXT NOT NULL,
    CANON_ANTERIOR INTEGER NOT NULL,
    CANON_NUEVO INTEGER NOT NULL,
    PORCENTAJE_INCREMENTO INTEGER,
    MOTIVO_RENOVACION TEXT,
    FECHA_RENOVACION TEXT DEFAULT (date('now')),
    CREATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    CREATED_BY TEXT,
    FOREIGN KEY (ID_CONTRATO_M) REFERENCES CONTRATOS_MANDATOS(ID_CONTRATO_M),
    FOREIGN KEY (ID_CONTRATO_A) REFERENCES CONTRATOS_ARRENDAMIENTOS(ID_CONTRATO_A),
    CHECK((ID_CONTRATO_M IS NOT NULL AND ID_CONTRATO_A IS NULL) OR (ID_CONTRATO_M IS NULL AND ID_CONTRATO_A IS NOT NULL))
);

CREATE UNIQUE INDEX idx_mandato_activo ON CONTRATOS_MANDATOS(ID_PROPIEDAD) WHERE ESTADO_CONTRATO_M = 'Activo';
CREATE UNIQUE INDEX idx_arriendo_activo ON CONTRATOS_ARRENDAMIENTOS(ID_PROPIEDAD) WHERE ESTADO_CONTRATO_A = 'Activo';

-- ==========================================
-- 7. OPERACIONES DIARIAS
-- ==========================================

CREATE TABLE RECAUDO_ARRENDAMIENTO (
    ID_RECAUDO INTEGER PRIMARY KEY AUTOINCREMENT,
    ID_CONTRATO_A INTEGER NOT NULL,
    VALOR_RECAUDO INTEGER NOT NULL CHECK(VALOR_RECAUDO > 0),
    FECHA_RECAUDO TEXT DEFAULT (datetime('now')),
    FECHA_VENCIMIENTO_RECAUDO TEXT NOT NULL,
    MEDIO_PAGO TEXT NOT NULL CHECK(MEDIO_PAGO IN ('Transferencia', 'Efectivo', 'Cheque', 'Consignación', 'PSE')),
    REFERENCIA_RECAUDO TEXT UNIQUE,
    PERIODO_RECAUDO TEXT NOT NULL,
    DIRECCION_CONTRATO_A TEXT,
    ESTADO_RECAUDO TEXT DEFAULT 'Pendiente' CHECK(ESTADO_RECAUDO IN ('Pendiente', 'Pagado', 'Mora', 'Anulado')),
    DIAS_MORA INTEGER DEFAULT 0 CHECK(DIAS_MORA >= 0),
    MOTIVO_ANULACION TEXT,
    CREATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    CREATED_BY TEXT,
    UPDATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    UPDATED_BY TEXT,
    FOREIGN KEY (ID_CONTRATO_A) REFERENCES CONTRATOS_ARRENDAMIENTOS(ID_CONTRATO_A)
);

CREATE TABLE INCIDENTES (
    ID_INCIDENTE INTEGER PRIMARY KEY AUTOINCREMENT,
    ID_PROPIEDAD INTEGER NOT NULL,
    ID_CONTRATO_M INTEGER,
    DESCRIPCION_INCIDENTE TEXT NOT NULL,
    COSTO_INCIDENTE INTEGER DEFAULT 0 CHECK(COSTO_INCIDENTE >= 0),
    FECHA_INCIDENTE TEXT NOT NULL,
    QUIEN_ARREGLA TEXT,
    APROBADO_POR TEXT,
    FECHA_ARREGLO TEXT,
    ESTADO TEXT DEFAULT 'Pendiente' CHECK(ESTADO IN ('Pendiente', 'En Proceso', 'Resuelto', 'Cancelado')),
    DIAS_SIN_RESOLVER INTEGER DEFAULT 0,
    MOTIVO_CANCELACION TEXT,
    CREATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    CREATED_BY TEXT,
    UPDATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    UPDATED_BY TEXT,
    FOREIGN KEY (ID_PROPIEDAD) REFERENCES PROPIEDADES(ID_PROPIEDAD),
    FOREIGN KEY (ID_CONTRATO_M) REFERENCES CONTRATOS_MANDATOS(ID_CONTRATO_M)
);

CREATE TABLE RECIBOS_PUBLICOS (
    ID_RECIBO_PUBLICO INTEGER PRIMARY KEY AUTOINCREMENT,
    ID_PROPIEDAD INTEGER NOT NULL,
    PERIODO_RECIBO TEXT NOT NULL,
    TIPO_SERVICIO TEXT NOT NULL CHECK(TIPO_SERVICIO IN ('Agua', 'Luz', 'Gas', 'Internet', 'Teléfono', 'Aseo', 'Otros')),
    VALOR_RECIBO INTEGER NOT NULL CHECK(VALOR_RECIBO >= 0),
    FECHA_VENCIMIENTO TEXT,
    FECHA_PAGO TEXT,
    COMPROBANTE TEXT,
    ESTADO TEXT DEFAULT 'Pendiente' CHECK(ESTADO IN ('Pendiente', 'Pagado', 'Vencido')),
    CREATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    CREATED_BY TEXT,
    UPDATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    UPDATED_BY TEXT,
    FOREIGN KEY (ID_PROPIEDAD) REFERENCES PROPIEDADES(ID_PROPIEDAD),
    UNIQUE(ID_PROPIEDAD, PERIODO_RECIBO, TIPO_SERVICIO)
);

-- ==========================================
-- 8. SISTEMA DE LIQUIDACIONES
-- ==========================================

CREATE TABLE LIQUIDACIONES_PROPIETARIOS (
    ID_LIQUIDACION_PROPIETARIO INTEGER PRIMARY KEY AUTOINCREMENT,
    ID_CONTRATO_M INTEGER NOT NULL,
    ID_PROPIETARIO INTEGER NOT NULL,
    PERIODO_LIQUIDACION TEXT NOT NULL,
    FECHA_VENCIMIENTO_PAGO TEXT NOT NULL,
    CANON_MANDATO_LIQUIDADO INTEGER NOT NULL CHECK(CANON_MANDATO_LIQUIDADO > 0),
    COMISION_ASESOR INTEGER NOT NULL CHECK(COMISION_ASESOR >= 0),
    COMISION_SEGURO INTEGER NOT NULL CHECK(COMISION_SEGURO >= 0),
    IVA_COMISION INTEGER NOT NULL CHECK(IVA_COMISION >= 0),
    VALOR_INCIDENTES INTEGER DEFAULT 0 CHECK(VALOR_INCIDENTES >= 0),
    IMPUESTO_4X1000 INTEGER NOT NULL CHECK(IMPUESTO_4X1000 >= 0),
    VALOR_ADMINISTRACION INTEGER DEFAULT 0 CHECK(VALOR_ADMINISTRACION >= 0),
    VALOR_RECIBOS_PUBLICOS INTEGER DEFAULT 0 CHECK(VALOR_RECIBOS_PUBLICOS >= 0),
    TOTAL_DESCUENTOS INTEGER NOT NULL CHECK(TOTAL_DESCUENTOS >= 0),
    VALOR_NETO_PROPIETARIO INTEGER NOT NULL,
    ESTADO_LIQUIDACION TEXT DEFAULT 'Pendiente' CHECK(ESTADO_LIQUIDACION IN ('Pendiente', 'Aprobada', 'Pagada', 'Mora', 'Anulada')),
    DIAS_MORA INTEGER DEFAULT 0 CHECK(DIAS_MORA >= 0),
    FECHA_CREACION TEXT DEFAULT (datetime('now', 'localtime')),
    FECHA_APROBACION TEXT,
    USUARIO_CREADOR TEXT,
    USUARIO_APROBADOR TEXT,
    OBSERVACIONES_LIQUIDACION TEXT,
    MOTIVO_ANULACION TEXT,
    CREATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    CREATED_BY TEXT,
    UPDATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    UPDATED_BY TEXT,
    FOREIGN KEY (ID_CONTRATO_M) REFERENCES CONTRATOS_MANDATOS(ID_CONTRATO_M),
    FOREIGN KEY (ID_PROPIETARIO) REFERENCES PROPIETARIOS(ID_PROPIETARIO),
    UNIQUE(ID_CONTRATO_M, PERIODO_LIQUIDACION)
);

CREATE TABLE LIQUIDACIONES_ASESORES (
    ID_LIQUIDACION_ASESOR INTEGER PRIMARY KEY AUTOINCREMENT,
    ID_CONTRATO_A INTEGER NOT NULL,
    ID_ASESOR INTEGER NOT NULL,
    PERIODO_LIQUIDACION TEXT NOT NULL,
    CANON_ARRENDAMIENTO_LIQUIDADO INTEGER NOT NULL CHECK(CANON_ARRENDAMIENTO_LIQUIDADO > 0),
    PORCENTAJE_COMISION INTEGER NOT NULL CHECK(PORCENTAJE_COMISION >= 0 AND PORCENTAJE_COMISION <= 10000),
    COMISION_BRUTA INTEGER NOT NULL CHECK(COMISION_BRUTA >= 0),
    TOTAL_DESCUENTOS INTEGER DEFAULT 0 CHECK(TOTAL_DESCUENTOS >= 0),
    VALOR_NETO_ASESOR INTEGER NOT NULL,
    ESTADO_LIQUIDACION TEXT DEFAULT 'Pendiente' CHECK(ESTADO_LIQUIDACION IN ('Pendiente', 'Aprobada', 'Pagada', 'Anulada')),
    FECHA_CREACION TEXT DEFAULT (datetime('now', 'localtime')),
    FECHA_APROBACION TEXT,
    USUARIO_CREADOR TEXT,
    USUARIO_APROBADOR TEXT,
    OBSERVACIONES_LIQUIDACION TEXT,
    MOTIVO_ANULACION TEXT,
    CREATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    CREATED_BY TEXT,
    UPDATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    UPDATED_BY TEXT,
    FOREIGN KEY (ID_CONTRATO_A) REFERENCES CONTRATOS_ARRENDAMIENTOS(ID_CONTRATO_A),
    FOREIGN KEY (ID_ASESOR) REFERENCES ASESORES(ID_ASESOR),
    UNIQUE(ID_CONTRATO_A, PERIODO_LIQUIDACION)
);

CREATE TABLE DESCUENTOS_ASESORES (
    ID_DESCUENTO_ASESOR INTEGER PRIMARY KEY AUTOINCREMENT,
    ID_LIQUIDACION_ASESOR INTEGER NOT NULL,
    TIPO_DESCUENTO TEXT NOT NULL CHECK(TIPO_DESCUENTO IN ('Préstamo', 'Anticipo', 'Sanción', 'Ajuste', 'Otros')),
    DESCRIPCION_DESCUENTO TEXT NOT NULL,
    VALOR_DESCUENTO INTEGER NOT NULL CHECK(VALOR_DESCUENTO >= 0),
    FECHA_REGISTRO TEXT DEFAULT (datetime('now', 'localtime')),
    CREATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    CREATED_BY TEXT,
    FOREIGN KEY (ID_LIQUIDACION_ASESOR) REFERENCES LIQUIDACIONES_ASESORES(ID_LIQUIDACION_ASESOR)
);

CREATE TABLE SALDOS_FAVOR (
    ID_SALDO_FAVOR INTEGER PRIMARY KEY AUTOINCREMENT,
    ID_PROPIETARIO INTEGER,
    ID_ASESOR INTEGER,
    TIPO_BENEFICIARIO TEXT NOT NULL CHECK(TIPO_BENEFICIARIO IN ('Propietario', 'Asesor')),
    VALOR_SALDO INTEGER NOT NULL CHECK(VALOR_SALDO > 0),
    MOTIVO TEXT NOT NULL,
    FECHA_GENERACION TEXT DEFAULT (date('now')),
    ESTADO TEXT DEFAULT 'Pendiente' CHECK(ESTADO IN ('Pendiente', 'Aplicado', 'Devuelto')),
    FECHA_RESOLUCION TEXT,
    OBSERVACIONES TEXT,
    CREATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    CREATED_BY TEXT,
    UPDATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    UPDATED_BY TEXT,
    FOREIGN KEY (ID_PROPIETARIO) REFERENCES PROPIETARIOS(ID_PROPIETARIO),
    FOREIGN KEY (ID_ASESOR) REFERENCES ASESORES(ID_ASESOR),
    CHECK((ID_PROPIETARIO IS NOT NULL AND ID_ASESOR IS NULL) OR (ID_PROPIETARIO IS NULL AND ID_ASESOR IS NOT NULL))
);

-- ==========================================
-- 9. PAGOS
-- ==========================================

CREATE TABLE PAGOS_PROPIETARIOS (
    ID_PAGO_PROPIETARIO INTEGER PRIMARY KEY AUTOINCREMENT,
    ID_LIQUIDACION_PROPIETARIO INTEGER NOT NULL,
    ID_PROPIETARIO INTEGER NOT NULL,
    VALOR_PAGO INTEGER NOT NULL CHECK(VALOR_PAGO > 0),
    FECHA_PAGO TEXT,
    FECHA_PROGRAMADA TEXT NOT NULL,
    MEDIO_PAGO TEXT CHECK(MEDIO_PAGO IN ('Transferencia', 'Cheque', 'Efectivo', 'PSE')),
    REFERENCIA_PAGO TEXT UNIQUE,
    BANCO_DESTINO TEXT,
    CUENTA_DESTINO TEXT,
    TIPO_CUENTA_DESTINO TEXT CHECK(TIPO_CUENTA_DESTINO IN ('Ahorros', 'Corriente')),
    ESTADO_PAGO TEXT DEFAULT 'Pendiente' CHECK(ESTADO_PAGO IN ('Pendiente', 'Programado', 'Pagado', 'Rechazado', 'Anulado')),
    MOTIVO_RECHAZO TEXT,
    COMPROBANTE_PAGO TEXT,
    OBSERVACIONES_PAGO TEXT,
    FECHA_CONFIRMACION TEXT,
    CREATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    CREATED_BY TEXT,
    UPDATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    UPDATED_BY TEXT,
    FOREIGN KEY (ID_LIQUIDACION_PROPIETARIO) REFERENCES LIQUIDACIONES_PROPIETARIOS(ID_LIQUIDACION_PROPIETARIO),
    FOREIGN KEY (ID_PROPIETARIO) REFERENCES PROPIETARIOS(ID_PROPIETARIO)
);

CREATE TABLE PAGOS_ASESORES (
    ID_PAGO_ASESOR INTEGER PRIMARY KEY AUTOINCREMENT,
    ID_LIQUIDACION_ASESOR INTEGER NOT NULL,
    ID_ASESOR INTEGER NOT NULL,
    VALOR_PAGO INTEGER NOT NULL CHECK(VALOR_PAGO > 0),
    FECHA_PAGO TEXT,
    FECHA_PROGRAMADA TEXT NOT NULL,
    MEDIO_PAGO TEXT CHECK(MEDIO_PAGO IN ('Transferencia', 'Cheque', 'Efectivo', 'PSE')),
    REFERENCIA_PAGO TEXT UNIQUE,
    ESTADO_PAGO TEXT DEFAULT 'Pendiente' CHECK(ESTADO_PAGO IN ('Pendiente', 'Programado', 'Pagado', 'Rechazado', 'Anulado')),
    MOTIVO_RECHAZO TEXT,
    COMPROBANTE_PAGO TEXT,
    OBSERVACIONES_PAGO TEXT,
    FECHA_CONFIRMACION TEXT,
    CREATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    CREATED_BY TEXT,
    UPDATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    UPDATED_BY TEXT,
    FOREIGN KEY (ID_LIQUIDACION_ASESOR) REFERENCES LIQUIDACIONES_ASESORES(ID_LIQUIDACION_ASESOR),
    FOREIGN KEY (ID_ASESOR) REFERENCES ASESORES(ID_ASESOR)
);

-- ==========================================
-- 10. SISTEMA DE ALERTAS Y NOTIFICACIONES
-- ==========================================

CREATE TABLE ALERTAS (
    ID_ALERTAS INTEGER PRIMARY KEY AUTOINCREMENT,
    TIPO_ALERTA TEXT NOT NULL CHECK(TIPO_ALERTA IN (
        'Vencimiento Contrato Mandato',
        'Vencimiento Contrato Arrendamiento',
        'Incremento IPC',
        'Mora Recaudo',
        'Mora Liquidación',
        'Incidente Sin Resolver',
        'Liquidación Pendiente Aprobación',
        'Asesor Sin Actividad',
        'Propietario Múltiples Moras',
        'Pago Rechazado',
        'Otros'
    )),
    DESCRIPCION_ALERTA TEXT NOT NULL,
    PRIORIDAD TEXT CHECK(PRIORIDAD IN ('Alta', 'Media', 'Baja')) DEFAULT 'Media',
    FECHA_GENERACION_ALERTA TEXT DEFAULT (datetime('now')),
    FECHA_VENCIMIENTO_ALERTA TEXT,
    ESTADO_ALERTA TEXT DEFAULT 'Pendiente' CHECK(ESTADO_ALERTA IN ('Pendiente', 'En Proceso', 'Resuelta', 'Archivada')),
    ID_ENTIDAD_RELACIONADA INTEGER,
    TIPO_ENTIDAD TEXT,
    USUARIO_ASIGNADO TEXT,
    ACCION_TOMADA TEXT,
    FECHA_ACCION TEXT,
    PLANTILLA_MENSAJE TEXT,
    DESTINATARIO_NOMBRE TEXT,
    DESTINATARIO_TELEFONO TEXT,
    DESTINATARIO_EMAIL TEXT,
    FECHA_RESOLUCION TEXT,
    RESUELTO_AUTOMATICAMENTE INTEGER DEFAULT 0 CHECK(RESUELTO_AUTOMATICAMENTE IN (0, 1)),
    CREATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    CREATED_BY TEXT
);

CREATE TABLE NOTIFICACIONES_ENVIADAS (
    ID_NOTIFICACION INTEGER PRIMARY KEY AUTOINCREMENT,
    ID_ALERTA INTEGER,
    TIPO_NOTIFICACION TEXT NOT NULL CHECK(TIPO_NOTIFICACION IN ('WhatsApp', 'Email', 'Sistema', 'SMS')),
    DESTINATARIO TEXT NOT NULL,
    ASUNTO TEXT,
    MENSAJE TEXT NOT NULL,
    FECHA_ENVIO TEXT DEFAULT (datetime('now', 'localtime')),
    ESTADO_ENVIO TEXT DEFAULT 'Pendiente' CHECK(ESTADO_ENVIO IN ('Pendiente', 'Enviado', 'Fallido', 'Entregado')),
    RESPUESTA_SISTEMA TEXT,
    INTENTOS_ENVIO INTEGER DEFAULT 1,
    FECHA_ENTREGA TEXT,
    CREATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    CREATED_BY TEXT,
    FOREIGN KEY (ID_ALERTA) REFERENCES ALERTAS(ID_ALERTAS)
);

CREATE TABLE PLANTILLAS_NOTIFICACIONES (
    ID_PLANTILLA INTEGER PRIMARY KEY AUTOINCREMENT,
    TIPO_ALERTA TEXT NOT NULL,
    CANAL TEXT NOT NULL CHECK(CANAL IN ('WhatsApp', 'Email', 'Sistema')),
    ASUNTO TEXT,
    MENSAJE_PLANTILLA TEXT NOT NULL,
    VARIABLES_DISPONIBLES TEXT,
    ESTADO INTEGER DEFAULT 1 CHECK(ESTADO IN (0, 1)),
    CREATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    CREATED_BY TEXT,
    UPDATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    UPDATED_BY TEXT,
    UNIQUE(TIPO_ALERTA, CANAL)
);

-- ==========================================
-- 11. GESTIÓN DE ARCHIVOS
-- ==========================================
CREATE TABLE ARCHIVOS_ADJUNTOS (
    ID_ARCHIVO INTEGER PRIMARY KEY AUTOINCREMENT,
    ID_ENTIDAD_RELACIONADA INTEGER NOT NULL,
    TIPO_ENTIDAD TEXT NOT NULL CHECK(TIPO_ENTIDAD IN (
    'PROPIEDAD',
    'CONTRATO_MANDATO',
    'CONTRATO_ARRENDAMIENTO',
    'PAGO_PROPIETARIO',
    'PAGO_ASESOR',
    'INCIDENTE',
    'RECIBO_PUBLICO',
    'LIQUIDACION_PROPIETARIO',
    'LIQUIDACION_ASESOR'
    )),
    TIPO_ARCHIVO TEXT NOT NULL CHECK(TIPO_ARCHIVO IN (
    'Foto Propiedad',
    'Escritura',
    'Certificado Tradición',
    'Contrato Firmado',
    'Documento Identidad',
    'Comprobante Pago',
    'Foto Incidente',
    'Cotización',
    'Factura',
    'Recibo Público',
    'Otros'
    )),
    NOMBRE_ARCHIVO TEXT NOT NULL,
    URL_ONEDRIVE TEXT NOT NULL,
    TAMAÑO_KB INTEGER,
    EXTENSION TEXT,
    DESCRIPCION TEXT,
    VERSION INTEGER DEFAULT 1,
    ESTADO INTEGER DEFAULT 1 CHECK(ESTADO IN (0, 1)),
    FECHA_CARGA TEXT DEFAULT (datetime('now', 'localtime')),
    CREATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    CREATED_BY TEXT
);

-- ==========================================
-- 12. AUDITORÍA Y BITÁCORA
-- ==========================================
CREATE TABLE AUDITORIA_CAMBIOS (
    ID_AUDITORIA INTEGER PRIMARY KEY AUTOINCREMENT,
    TABLA TEXT NOT NULL,
    ID_REGISTRO INTEGER NOT NULL,
    TIPO_OPERACION TEXT NOT NULL CHECK(TIPO_OPERACION IN ('INSERT', 'UPDATE', 'DELETE', 'ESTADO_CHANGE')),
    CAMPO_MODIFICADO TEXT,
    VALOR_ANTERIOR TEXT,
    VALOR_NUEVO TEXT,
    USUARIO TEXT NOT NULL,
    FECHA_CAMBIO TEXT DEFAULT (datetime('now', 'localtime')),
    MOTIVO_CAMBIO TEXT,
    IP_ORIGEN TEXT
);

CREATE TABLE HISTORIAL_ESTADOS (
    ID_HISTORIAL INTEGER PRIMARY KEY AUTOINCREMENT,
    TIPO_ENTIDAD TEXT NOT NULL CHECK(TIPO_ENTIDAD IN (
    'CONTRATO_MANDATO',
    'CONTRATO_ARRENDAMIENTO',
    'LIQUIDACION_PROPIETARIO',
    'LIQUIDACION_ASESOR',
    'PAGO_PROPIETARIO',
    'PAGO_ASESOR',
    'RECAUDO',
    'INCIDENTE',
    'ALERTA'
    )),
    ID_ENTIDAD INTEGER NOT NULL,
    ESTADO_ANTERIOR TEXT NOT NULL,
    ESTADO_NUEVO TEXT NOT NULL,
    MOTIVO_CAMBIO TEXT,
    FECHA_CAMBIO TEXT DEFAULT (datetime('now', 'localtime')),
    USUARIO TEXT NOT NULL,
    REQUIRIO_APROBACION INTEGER DEFAULT 0 CHECK(REQUIRIO_APROBACION IN (0, 1)),
    APROBADO_POR TEXT
);

-- ==========================================
-- 13. CONFIGURACIÓN DEL SISTEMA
-- ==========================================
CREATE TABLE PARAMETROS_SISTEMA (
    ID_PARAMETRO INTEGER PRIMARY KEY AUTOINCREMENT,
    NOMBRE_PARAMETRO TEXT NOT NULL UNIQUE,
    VALOR_PARAMETRO TEXT NOT NULL,
    TIPO_DATO TEXT CHECK(TIPO_DATO IN ('INTEGER', 'TEXT', 'DECIMAL', 'BOOLEAN')),
    DESCRIPCION TEXT,
    CATEGORIA TEXT,
    MODIFICABLE INTEGER DEFAULT 1 CHECK(MODIFICABLE IN (0, 1)),
    CREATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    UPDATED_AT TEXT DEFAULT (datetime('now', 'localtime')),
    UPDATED_BY TEXT
);

-- Insertar parámetros por defecto
INSERT INTO PARAMETROS_SISTEMA (NOMBRE_PARAMETRO, VALOR_PARAMETRO, TIPO_DATO, DESCRIPCION, CATEGORIA, MODIFICABLE) VALUES
('COMISION_ASESOR_ARRIENDO_DEFAULT', '800', 'INTEGER', 'Comisión por defecto para asesores en arrendamiento (base 100: 8%)', 'COMISIONES', 1),
('COMISION_ASESOR_VENTA_DEFAULT', '300', 'INTEGER', 'Comisión por defecto para asesores en venta (base 100: 3%)', 'COMISIONES', 1),
('COMISION_SEGURO_DEFAULT', '200', 'INTEGER', 'Comisión de seguro por defecto (base 100: 2%)', 'COMISIONES', 1),
('IVA_DEFAULT', '1900', 'INTEGER', 'IVA por defecto (base 100: 19%)', 'IMPUESTOS', 1),
('IMPUESTO_4X1000', '4', 'INTEGER', 'Impuesto 4x1000 (base 1000)', 'IMPUESTOS', 0),
('CANON_MINIMO', '70000000', 'INTEGER', 'Canon mínimo permitido en centavos ($700,000)', 'VALIDACIONES', 1),
('CANON_MAXIMO', '200000000', 'INTEGER', 'Canon máximo permitido en centavos ($2,000,000)', 'VALIDACIONES', 1),
('DIAS_VENCIMIENTO_PAGO', '5', 'INTEGER', 'Día del mes límite para pagos', 'OPERACIONES', 1),
('DIAS_ALERTA_MANDATO', '30', 'INTEGER', 'Días de anticipación para alerta de vencimiento de mandato', 'ALERTAS', 1),
('DIAS_ALERTA_ARRENDAMIENTO', '90', 'INTEGER', 'Días de anticipación para alerta de vencimiento de arrendamiento', 'ALERTAS', 1),
('DIAS_ALERTA_IPC', '30', 'INTEGER', 'Días de anticipación para alerta de incremento IPC', 'ALERTAS', 1),
('DIAS_MAXIMOS_INCIDENTE_SIN_RESOLVER', '15', 'INTEGER', 'Días máximos sin resolver un incidente antes de generar alerta', 'ALERTAS', 1),
('DIAS_MAXIMOS_LIQUIDACION_SIN_APROBAR', '3', 'INTEGER', 'Días máximos sin aprobar liquidación antes de generar alerta', 'ALERTAS', 1),
('MESES_ASESOR_SIN_ACTIVIDAD', '3', 'INTEGER', 'Meses sin actividad del asesor antes de generar alerta', 'ALERTAS', 1),
('RETENCION_DATOS_ANIOS', '5', 'INTEGER', 'Años de retención de datos históricos', 'SISTEMA', 1),
('WHATSAPP_HABILITADO', '1', 'BOOLEAN', 'Notificaciones por WhatsApp habilitadas', 'NOTIFICACIONES', 1),
('EMAIL_HABILITADO', '1', 'BOOLEAN', 'Notificaciones por email habilitadas', 'NOTIFICACIONES', 1);

-- ==========================================
-- 14. ÍNDICES PARA OPTIMIZACIÓN
-- ==========================================
-- Índices de búsqueda frecuente
CREATE INDEX idx_personas_documento ON PERSONAS(TIPO_DOCUMENTO, NUMERO_DOCUMENTO);
CREATE INDEX idx_personas_estado ON PERSONAS(ESTADO_REGISTRO);
CREATE INDEX idx_propiedades_disponibilidad ON PROPIEDADES(DISPONIBILIDAD_PROPIEDAD);
CREATE INDEX idx_propiedades_municipio ON PROPIEDADES(ID_MUNICIPIO, ESTADO_REGISTRO);
CREATE INDEX idx_propiedades_estado ON PROPIEDADES(ESTADO_REGISTRO);
-- Índices de contratos
CREATE INDEX idx_contratos_mandatos_estado ON CONTRATOS_MANDATOS(ESTADO_CONTRATO_M);
CREATE INDEX idx_contratos_mandatos_fechas ON CONTRATOS_MANDATOS(FECHA_INICIO_CONTRATO_M, FECHA_FIN_CONTRATO_M);
CREATE INDEX idx_contratos_mandatos_propietario ON CONTRATOS_MANDATOS(ID_PROPIETARIO, ESTADO_CONTRATO_M);
CREATE INDEX idx_contratos_mandatos_asesor ON CONTRATOS_MANDATOS(ID_ASESOR, ESTADO_CONTRATO_M);
CREATE INDEX idx_contratos_arrendamientos_estado ON CONTRATOS_ARRENDAMIENTOS(ESTADO_CONTRATO_A);
CREATE INDEX idx_contratos_arrendamientos_fechas ON CONTRATOS_ARRENDAMIENTOS(FECHA_INICIO_CONTRATO_A, FECHA_FIN_CONTRATO_A);
CREATE INDEX idx_contratos_arrendamientos_arrendatario ON CONTRATOS_ARRENDAMIENTOS(ID_ARRENDATARIO, ESTADO_CONTRATO_A);
-- Índices de liquidaciones
CREATE INDEX idx_liquidaciones_propietarios_periodo ON LIQUIDACIONES_PROPIETARIOS(PERIODO_LIQUIDACION);
CREATE INDEX idx_liquidaciones_propietarios_estado ON LIQUIDACIONES_PROPIETARIOS(ESTADO_LIQUIDACION);
CREATE INDEX idx_liquidaciones_propietarios_propietario ON LIQUIDACIONES_PROPIETARIOS(ID_PROPIETARIO, ESTADO_LIQUIDACION);
CREATE INDEX idx_liquidaciones_propietarios_mora ON LIQUIDACIONES_PROPIETARIOS(ESTADO_LIQUIDACION, DIAS_MORA) WHERE ESTADO_LIQUIDACION = 'Mora';
CREATE INDEX idx_liquidaciones_asesores_periodo ON LIQUIDACIONES_ASESORES(PERIODO_LIQUIDACION);
CREATE INDEX idx_liquidaciones_asesores_estado ON LIQUIDACIONES_ASESORES(ESTADO_LIQUIDACION);
CREATE INDEX idx_liquidaciones_asesores_asesor ON LIQUIDACIONES_ASESORES(ID_ASESOR, ESTADO_LIQUIDACION);
-- Índices de pagos
CREATE INDEX idx_pagos_propietarios_estado ON PAGOS_PROPIETARIOS(ESTADO_PAGO);
CREATE INDEX idx_pagos_propietarios_fecha ON PAGOS_PROPIETARIOS(FECHA_PROGRAMADA, ESTADO_PAGO);
CREATE INDEX idx_pagos_asesores_estado ON PAGOS_ASESORES(ESTADO_PAGO);
CREATE INDEX idx_pagos_asesores_fecha ON PAGOS_ASESORES(FECHA_PROGRAMADA, ESTADO_PAGO);
-- Índices de recaudos
CREATE INDEX idx_recaudo_periodo ON RECAUDO_ARRENDAMIENTO(PERIODO_RECAUDO);
CREATE INDEX idx_recaudo_estado ON RECAUDO_ARRENDAMIENTO(ESTADO_RECAUDO);
CREATE INDEX idx_recaudo_mora ON RECAUDO_ARRENDAMIENTO(ESTADO_RECAUDO, DIAS_MORA) WHERE ESTADO_RECAUDO = 'Mora';
CREATE INDEX idx_recaudo_contrato ON RECAUDO_ARRENDAMIENTO(ID_CONTRATO_A, PERIODO_RECAUDO);
-- Índices de incidentes
CREATE INDEX idx_incidentes_fecha ON INCIDENTES(ID_PROPIEDAD, FECHA_INCIDENTE);
CREATE INDEX idx_incidentes_estado ON INCIDENTES(ESTADO);
CREATE INDEX idx_incidentes_pendientes ON INCIDENTES(ESTADO, DIAS_SIN_RESOLVER) WHERE ESTADO = 'Pendiente';
-- Índices de recibos públicos
CREATE INDEX idx_recibos_publicos_periodo ON RECIBOS_PUBLICOS(PERIODO_RECIBO);
CREATE INDEX idx_recibos_publicos_propiedad ON RECIBOS_PUBLICOS(ID_PROPIEDAD, PERIODO_RECIBO);
CREATE INDEX idx_recibos_publicos_estado ON RECIBOS_PUBLICOS(ESTADO);
-- Índices de alertas
CREATE INDEX idx_alertas_estado ON ALERTAS(ESTADO_ALERTA);
CREATE INDEX idx_alertas_tipo ON ALERTAS(TIPO_ALERTA, ESTADO_ALERTA);
CREATE INDEX idx_alertas_entidad ON ALERTAS(TIPO_ENTIDAD, ID_ENTIDAD_RELACIONADA);
CREATE INDEX idx_alertas_prioridad ON ALERTAS(PRIORIDAD, ESTADO_ALERTA);
CREATE INDEX idx_alertas_usuario ON ALERTAS(USUARIO_ASIGNADO, ESTADO_ALERTA);
-- Índices de notificaciones
CREATE INDEX idx_notificaciones_estado ON NOTIFICACIONES_ENVIADAS(ESTADO_ENVIO);
CREATE INDEX idx_notificaciones_fecha ON NOTIFICACIONES_ENVIADAS(FECHA_ENVIO);
CREATE INDEX idx_notificaciones_alerta ON NOTIFICACIONES_ENVIADAS(ID_ALERTA);
-- Índices de archivos
CREATE INDEX idx_archivos_entidad ON ARCHIVOS_ADJUNTOS(TIPO_ENTIDAD, ID_ENTIDAD_RELACIONADA);
CREATE INDEX idx_archivos_tipo ON ARCHIVOS_ADJUNTOS(TIPO_ARCHIVO, ESTADO);
-- Índices de auditoría
CREATE INDEX idx_auditoria_tabla ON AUDITORIA_CAMBIOS(TABLA, ID_REGISTRO);
CREATE INDEX idx_auditoria_usuario ON AUDITORIA_CAMBIOS(USUARIO, FECHA_CAMBIO);
CREATE INDEX idx_auditoria_fecha ON AUDITORIA_CAMBIOS(FECHA_CAMBIO);
CREATE INDEX idx_historial_entidad ON HISTORIAL_ESTADOS(TIPO_ENTIDAD, ID_ENTIDAD);
CREATE INDEX idx_historial_fecha ON HISTORIAL_ESTADOS(FECHA_CAMBIO);
-- Índices de usuarios
CREATE INDEX idx_usuarios_rol ON USUARIOS(ROL, ESTADO_USUARIO);
CREATE INDEX idx_sesiones_usuario ON SESIONES_USUARIO(ID_USUARIO, FECHA_INICIO);

-- ==========================================
-- 15. TRIGGERS Y AUTOMATIZACIONES (CORREGIDOS)
-- ==========================================

-- 1. AUDITORÍA: CONTRATOS DE ARRENDAMIENTO
CREATE TRIGGER TRG_AUDITORIA_CONTRATOS_A_UPDATE
AFTER UPDATE ON CONTRATOS_ARRENDAMIENTOS
BEGIN
    INSERT INTO AUDITORIA_CAMBIOS (TABLA, ID_REGISTRO, TIPO_OPERACION, CAMPO_MODIFICADO, VALOR_ANTERIOR, VALOR_NUEVO, USUARIO, MOTIVO_CAMBIO)
    SELECT 'CONTRATOS_ARRENDAMIENTOS', OLD.ID_CONTRATO_A, 'UPDATE', 'ESTADO_CONTRATO_A', OLD.ESTADO_CONTRATO_A, NEW.ESTADO_CONTRATO_A, 'SISTEMA', NEW.MOTIVO_CANCELACION
    WHERE OLD.ESTADO_CONTRATO_A <> NEW.ESTADO_CONTRATO_A;
END;

-- 2. AUDITORÍA: LIQUIDACIONES
CREATE TRIGGER TRG_AUDITORIA_LIQUIDACIONES_P_UPDATE
AFTER UPDATE ON LIQUIDACIONES_PROPIETARIOS
BEGIN
    INSERT INTO AUDITORIA_CAMBIOS (TABLA, ID_REGISTRO, TIPO_OPERACION, CAMPO_MODIFICADO, VALOR_ANTERIOR, VALOR_NUEVO, USUARIO)
    SELECT 'LIQUIDACIONES_PROPIETARIOS', OLD.ID_LIQUIDACION_PROPIETARIO, 'UPDATE', 'ESTADO_LIQUIDACION', OLD.ESTADO_LIQUIDACION, NEW.ESTADO_LIQUIDACION, 'SISTEMA'
    WHERE OLD.ESTADO_LIQUIDACION <> NEW.ESTADO_LIQUIDACION;
END;

-- 3. REGLA DE NEGOCIO: PROHIBIR ELIMINACIÓN FÍSICA
CREATE TRIGGER TRG_PREVENIR_DELETE_CONTRATOS
BEFORE DELETE ON CONTRATOS_ARRENDAMIENTOS
BEGIN
    SELECT RAISE(ABORT, 'Error: No está permitido eliminar contratos físicamente. Debe cambiar su estado a "Cancelado" o "Finalizado" para mantener el histórico.');
END;

-- 4. VALIDACIÓN: FECHAS COHERENTES
CREATE TRIGGER TRG_VALIDAR_FECHAS_CONTRATO
BEFORE INSERT ON CONTRATOS_ARRENDAMIENTOS
BEGIN
    SELECT RAISE(ABORT, 'Error: La fecha de finalización no puede ser anterior a la fecha de inicio.')
    WHERE NEW.FECHA_FIN_CONTRATO_A <= NEW.FECHA_INICIO_CONTRATO_A;
END;

-- 5. VALIDACIÓN: SOLAPAMIENTO DE CONTRATOS
CREATE TRIGGER TRG_EVITAR_SOLAPAMIENTO_ARRIENDO
BEFORE INSERT ON CONTRATOS_ARRENDAMIENTOS
BEGIN
    SELECT RAISE(ABORT, 'Error: Esta propiedad ya tiene un contrato de arrendamiento ACTIVO. Debe finalizar el anterior primero.')
    WHERE EXISTS (
        SELECT 1 FROM CONTRATOS_ARRENDAMIENTOS 
        WHERE ID_PROPIEDAD = NEW.ID_PROPIEDAD 
        AND ESTADO_CONTRATO_A = 'Activo'
    );
END;

CREATE TRIGGER TRG_EVITAR_SOLAPAMIENTO_MANDATO
BEFORE INSERT ON CONTRATOS_MANDATOS
BEGIN
    SELECT RAISE(ABORT, 'Error: Esta propiedad ya tiene un contrato de mandato ACTIVO.')
    WHERE EXISTS (
        SELECT 1 FROM CONTRATOS_MANDATOS 
        WHERE ID_PROPIEDAD = NEW.ID_PROPIEDAD 
        AND ESTADO_CONTRATO_M = 'Activo'
    );
END;

-- 6. AUTOMATIZACIÓN: DISPONIBILIDAD DE PROPIEDAD
CREATE TRIGGER TRG_ACTUALIZAR_DISPONIBILIDAD_OCUPADA
AFTER INSERT ON CONTRATOS_ARRENDAMIENTOS
WHEN NEW.ESTADO_CONTRATO_A = 'Activo'
BEGIN
    UPDATE PROPIEDADES 
    SET DISPONIBILIDAD_PROPIEDAD = 0 
    WHERE ID_PROPIEDAD = NEW.ID_PROPIEDAD;
END;

CREATE TRIGGER TRG_ACTUALIZAR_DISPONIBILIDAD_LIBRE
AFTER UPDATE ON CONTRATOS_ARRENDAMIENTOS
WHEN NEW.ESTADO_CONTRATO_A IN ('Finalizado', 'Cancelado') 
AND OLD.ESTADO_CONTRATO_A = 'Activo'
BEGIN
    UPDATE PROPIEDADES 
    SET DISPONIBILIDAD_PROPIEDAD = 1 
    WHERE ID_PROPIEDAD = NEW.ID_PROPIEDAD;
END;

-- 7. AUTOMATIZACIÓN: GENERAR PAGO AL APROBAR
CREATE TRIGGER TRG_AUTO_CREAR_PAGO_PROPIETARIO
AFTER UPDATE ON LIQUIDACIONES_PROPIETARIOS
WHEN NEW.ESTADO_LIQUIDACION = 'Aprobada' AND OLD.ESTADO_LIQUIDACION <> 'Aprobada'
BEGIN
    INSERT INTO PAGOS_PROPIETARIOS (
        ID_LIQUIDACION_PROPIETARIO,
        ID_PROPIETARIO,
        VALOR_PAGO,
        FECHA_PROGRAMADA,
        ESTADO_PAGO,
        OBSERVACIONES_PAGO
    )
    VALUES (
        NEW.ID_LIQUIDACION_PROPIETARIO,
        NEW.ID_PROPIETARIO,
        NEW.VALOR_NETO_PROPIETARIO,
        date('now', '+1 day'), 
        'Pendiente',
        'Generado automáticamente al aprobar liquidación #' || NEW.ID_LIQUIDACION_PROPIETARIO
    );
END;

-- 8. AUTOMATIZACIÓN: VALIDAR MOTIVO CANCELACIÓN
CREATE TRIGGER TRG_EXIGIR_MOTIVO_CANCELACION
BEFORE UPDATE ON CONTRATOS_ARRENDAMIENTOS
WHEN NEW.ESTADO_CONTRATO_A = 'Cancelado' 
AND (NEW.MOTIVO_CANCELACION IS NULL OR NEW.MOTIVO_CANCELACION = '')
BEGIN
    SELECT RAISE(ABORT, 'Error: Para cancelar un contrato es OBLIGATORIO ingresar un motivo de cancelación.');
END;

-- ==========================================
-- 16. VISTAS PARA REPORTES Y OPERACIONES
-- ==========================================

-- VISTA 1: CALCULO AUTOMÁTICO DE MORA
DROP VIEW IF EXISTS VW_ALERTA_MORA_DIARIA;
CREATE VIEW VW_ALERTA_MORA_DIARIA AS
SELECT 
    r.ID_RECAUDO,
    ca.ID_CONTRATO_A,
    p.DIRECCION_PROPIEDAD,
    arr_p.NOMBRE_COMPLETO AS ARRENDATARIO,
    arr_p.TELEFONO_PRINCIPAL,
    r.VALOR_RECAUDO,
    r.FECHA_VENCIMIENTO_RECAUDO,
    date('now') AS FECHA_HOY,
    CAST((julianday('now') - julianday(r.FECHA_VENCIMIENTO_RECAUDO)) AS INTEGER) AS DIAS_RETRASO
FROM RECAUDO_ARRENDAMIENTO r
JOIN CONTRATOS_ARRENDAMIENTOS ca ON r.ID_CONTRATO_A = ca.ID_CONTRATO_A
JOIN PROPIEDADES p ON ca.ID_PROPIEDAD = p.ID_PROPIEDAD
JOIN ARRENDATARIOS arr ON ca.ID_ARRENDATARIO = arr.ID_ARRENDATARIO
JOIN PERSONAS arr_p ON arr.ID_PERSONA = arr_p.ID_PERSONA
WHERE r.ESTADO_RECAUDO IN ('Pendiente', 'Mora')
AND r.FECHA_VENCIMIENTO_RECAUDO < date('now');

-- VISTA 2: CONTRATOS POR VENCER
DROP VIEW IF EXISTS VW_ALERTA_VENCIMIENTO_CONTRATOS;
CREATE VIEW VW_ALERTA_VENCIMIENTO_CONTRATOS AS
SELECT 
    ca.ID_CONTRATO_A,
    p.DIRECCION_PROPIEDAD,
    arr_p.NOMBRE_COMPLETO AS ARRENDATARIO,
    arr_p.TELEFONO_PRINCIPAL, 
    ca.FECHA_FIN_CONTRATO_A,
    CAST((julianday(ca.FECHA_FIN_CONTRATO_A) - julianday('now')) AS INTEGER) AS DIAS_RESTANTES
FROM CONTRATOS_ARRENDAMIENTOS ca
JOIN PROPIEDADES p ON ca.ID_PROPIEDAD = p.ID_PROPIEDAD
JOIN ARRENDATARIOS arr ON ca.ID_ARRENDATARIO = arr.ID_ARRENDATARIO
JOIN PERSONAS arr_p ON arr.ID_PERSONA = arr_p.ID_PERSONA
WHERE ca.ESTADO_CONTRATO_A = 'Activo'
AND ca.FECHA_FIN_CONTRATO_A <= date('now', '+90 days');

-- VISTA 3: PROPIEDADES DISPONIBLES DETALLADA
DROP VIEW IF EXISTS VW_REPORTE_DISPONIBLES;
CREATE VIEW VW_REPORTE_DISPONIBLES AS
SELECT 
    p.ID_PROPIEDAD,
    m.NOMBRE_MUNICIPIO AS CIUDAD,
    p.DIRECCION_PROPIEDAD,
    p.ESTRATO,
    p.CANON_ARRENDAMIENTO_ESTIMADO AS PRECIO, 
    p.HABITACIONES,
    p.BANO,
    p.AREA_M2
FROM PROPIEDADES p
JOIN MUNICIPIOS m ON p.ID_MUNICIPIO = m.ID_MUNICIPIO
WHERE p.DISPONIBILIDAD_PROPIEDAD = 1
AND p.ESTADO_REGISTRO = 1;