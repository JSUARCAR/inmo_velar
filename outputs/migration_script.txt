-- Script de migración de SQLite a PostgreSQL para DB_Inmo_Velar
-- Generado basado en el esquema de sqlite_master_dump.txt
-- Todas las tablas, índices, triggers y vistas han sido convertidas.

-- Crear esquema si es necesario (opcional)
-- CREATE SCHEMA IF NOT EXISTS inmobiliaria;

-- Tabla USUARIOS
CREATE TABLE USUARIOS (
    ID_USUARIO SERIAL PRIMARY KEY,
    NOMBRE_USUARIO TEXT NOT NULL UNIQUE,
    CONTRASENA_HASH TEXT NOT NULL,
    ROL TEXT NOT NULL CHECK(ROL IN ('Administrador', 'Asesor')),
    ESTADO_USUARIO INTEGER DEFAULT 1 CHECK(ESTADO_USUARIO IN (0, 1)),
    ULTIMO_ACCESO TIMESTAMP,
    FECHA_CREACION TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY TEXT,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_BY TEXT
);

-- Tabla SESIONES_USUARIO
CREATE TABLE SESIONES_USUARIO (
    ID_SESION SERIAL PRIMARY KEY,
    ID_USUARIO INTEGER NOT NULL,
    FECHA_INICIO TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FECHA_FIN TIMESTAMP,
    TOKEN_SESION TEXT UNIQUE,
    FOREIGN KEY (ID_USUARIO) REFERENCES USUARIOS(ID_USUARIO)
);

-- Tabla MUNICIPIOS
CREATE TABLE MUNICIPIOS (
    ID_MUNICIPIO SERIAL PRIMARY KEY,
    NOMBRE_MUNICIPIO TEXT NOT NULL,
    DEPARTAMENTO TEXT NOT NULL,
    ESTADO_REGISTRO INTEGER DEFAULT 1 CHECK(ESTADO_REGISTRO IN (0, 1)),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY TEXT,
    UNIQUE(NOMBRE_MUNICIPIO, DEPARTAMENTO)
);

-- Tabla IPC
CREATE TABLE IPC (
    ID_IPC SERIAL PRIMARY KEY,
    ANIO INTEGER UNIQUE NOT NULL,
    VALOR_IPC INTEGER NOT NULL CHECK(VALOR_IPC >= 0 AND VALOR_IPC <= 10000),
    FECHA_PUBLICACION TIMESTAMP,
    ESTADO_REGISTRO INTEGER DEFAULT 1 CHECK(ESTADO_REGISTRO IN (0, 1)),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY TEXT
);

-- Tabla PERSONAS
CREATE TABLE PERSONAS (
    ID_PERSONA SERIAL PRIMARY KEY,
    TIPO_DOCUMENTO TEXT CHECK(TIPO_DOCUMENTO IN ('CC', 'CE', 'NIT', 'PASAPORTE')) DEFAULT 'CC',
    NUMERO_DOCUMENTO TEXT NOT NULL,
    NOMBRE_COMPLETO TEXT NOT NULL,
    TELEFONO_PRINCIPAL TEXT,
    CORREO_ELECTRONICO TEXT,
    DIRECCION_PRINCIPAL TEXT,
    ESTADO_REGISTRO INTEGER DEFAULT 1 CHECK(ESTADO_REGISTRO IN (0, 1)),
    MOTIVO_INACTIVACION TEXT,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY TEXT,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_BY TEXT,
    UNIQUE(TIPO_DOCUMENTO, NUMERO_DOCUMENTO)
);

-- Tabla ASESORES
CREATE TABLE ASESORES (
    ID_ASESOR SERIAL PRIMARY KEY,
    ID_PERSONA INTEGER NOT NULL UNIQUE,
    ID_USUARIO INTEGER UNIQUE,
    COMISION_PORCENTAJE_ARRIENDO INTEGER NOT NULL DEFAULT 800 CHECK(COMISION_PORCENTAJE_ARRIENDO >= 0 AND COMISION_PORCENTAJE_ARRIENDO <= 10000),
    COMISION_PORCENTAJE_VENTA INTEGER NOT NULL DEFAULT 300 CHECK(COMISION_PORCENTAJE_VENTA >= 0 AND COMISION_PORCENTAJE_VENTA <= 10000),
    FECHA_INGRESO DATE DEFAULT CURRENT_DATE,
    ESTADO INTEGER DEFAULT 1 CHECK(ESTADO IN (0, 1)),
    MOTIVO_INACTIVACION TEXT,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY TEXT,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_BY TEXT,
    FOREIGN KEY (ID_PERSONA) REFERENCES PERSONAS(ID_PERSONA),
    FOREIGN KEY (ID_USUARIO) REFERENCES USUARIOS(ID_USUARIO)
);

-- Tabla PROPIETARIOS
CREATE TABLE PROPIETARIOS (
    ID_PROPIETARIO SERIAL PRIMARY KEY,
    ID_PERSONA INTEGER NOT NULL UNIQUE,
    BANCO_PROPIETARIO TEXT,
    NUMERO_CUENTA_PROPIETARIO TEXT,
    TIPO_CUENTA TEXT CHECK(TIPO_CUENTA IN ('Ahorros', 'Corriente')),
    OBSERVACIONES_PROPIETARIO TEXT,
    ESTADO_PROPIETARIO INTEGER DEFAULT 1 CHECK(ESTADO_PROPIETARIO IN (0, 1)),
    FECHA_INGRESO_PROPIETARIO DATE DEFAULT CURRENT_DATE,
    MOTIVO_INACTIVACION TEXT,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY TEXT,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_BY TEXT,
    FOREIGN KEY (ID_PERSONA) REFERENCES PERSONAS(ID_PERSONA)
);

-- Tabla SEGUROS
CREATE TABLE SEGUROS (
    ID_SEGURO SERIAL PRIMARY KEY,
    NOMBRE_SEGURO TEXT NOT NULL UNIQUE,
    FECHA_INICIO_SEGURO TIMESTAMP,
    PORCENTAJE_SEGURO INTEGER NOT NULL DEFAULT 200 CHECK(PORCENTAJE_SEGURO >= 0 AND PORCENTAJE_SEGURO <= 10000),
    ESTADO_SEGURO INTEGER DEFAULT 1 CHECK(ESTADO_SEGURO IN (0, 1)),
    FECHA_INGRESO_SEGURO DATE DEFAULT CURRENT_DATE,
    MOTIVO_INACTIVACION TEXT,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY TEXT,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_BY TEXT
);

-- Tabla ARRENDATARIOS
CREATE TABLE ARRENDATARIOS (
    ID_ARRENDATARIO SERIAL PRIMARY KEY,
    ID_PERSONA INTEGER NOT NULL UNIQUE,
    ID_SEGURO INTEGER,
    CODIGO_APROBACION_SEGURO TEXT,
    DIRECCION_REFERENCIA TEXT,
    ESTADO_ARRENDATARIO INTEGER DEFAULT 1 CHECK(ESTADO_ARRENDATARIO IN (0, 1)),
    FECHA_INGRESO_ARRENDATARIO DATE DEFAULT CURRENT_DATE,
    MOTIVO_INACTIVACION TEXT,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY TEXT,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_BY TEXT,
    FOREIGN KEY (ID_PERSONA) REFERENCES PERSONAS(ID_PERSONA),
    FOREIGN KEY (ID_SEGURO) REFERENCES SEGUROS(ID_SEGURO)
);

-- Tabla CODEUDORES
CREATE TABLE CODEUDORES (
    ID_CODEUDOR SERIAL PRIMARY KEY,
    ID_PERSONA INTEGER NOT NULL UNIQUE,
    FECHA_INGRESO_CODEUDOR DATE DEFAULT CURRENT_DATE,
    ESTADO_REGISTRO INTEGER DEFAULT 1 CHECK(ESTADO_REGISTRO IN (0, 1)),
    MOTIVO_INACTIVACION TEXT,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY TEXT,
    FOREIGN KEY (ID_PERSONA) REFERENCES PERSONAS(ID_PERSONA)
);

-- Tabla PROPIEDADES
CREATE TABLE PROPIEDADES (
    ID_PROPIEDAD SERIAL PRIMARY KEY,
    MATRICULA_INMOBILIARIA TEXT NOT NULL UNIQUE,
    ID_MUNICIPIO INTEGER NOT NULL,
    DIRECCION_PROPIEDAD TEXT NOT NULL,
    TIPO_PROPIEDAD TEXT NOT NULL,
    DISPONIBILIDAD_PROPIEDAD INTEGER DEFAULT 1 CHECK(DISPONIBILIDAD_PROPIEDAD IN (0, 1)),
    AREA_M2 DECIMAL(10,2) NOT NULL CHECK(AREA_M2 > 0),
    HABITACIONES INTEGER DEFAULT 0 CHECK(HABITACIONES >= 0),
    BANO INTEGER DEFAULT 0 CHECK(BANO >= 0),
    PARQUEADERO INTEGER DEFAULT 0 CHECK(PARQUEADERO >= 0),
    ESTRATO INTEGER CHECK(ESTRATO BETWEEN 1 AND 6),
    VALOR_ADMINISTRACION INTEGER DEFAULT 0 CHECK(VALOR_ADMINISTRACION >= 0),
    CANON_ARRENDAMIENTO_ESTIMADO INTEGER DEFAULT 0 CHECK(CANON_ARRENDAMIENTO_ESTIMADO >= 0),
    VALOR_VENTA_PROPIEDAD INTEGER DEFAULT 0 CHECK(VALOR_VENTA_PROPIEDAD >= 0),
    COMISION_VENTA_PROPIEDAD INTEGER DEFAULT 0 CHECK(COMISION_VENTA_PROPIEDAD >= 0),
    OBSERVACIONES_PROPIEDAD TEXT,
    FECHA_INGRESO_PROPIEDAD DATE DEFAULT CURRENT_DATE,
    ESTADO_REGISTRO INTEGER DEFAULT 1 CHECK(ESTADO_REGISTRO IN (0, 1)),
    MOTIVO_INACTIVACION TEXT,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY TEXT,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_BY TEXT,
    FOREIGN KEY (ID_MUNICIPIO) REFERENCES MUNICIPIOS(ID_MUNICIPIO)
);

-- Tabla RENOVACIONES_CONTRATOS
CREATE TABLE RENOVACIONES_CONTRATOS (
    ID_RENOVACION SERIAL PRIMARY KEY,
    ID_CONTRATO_M INTEGER,
    ID_CONTRATO_A INTEGER,
    TIPO_CONTRATO TEXT NOT NULL CHECK(TIPO_CONTRATO IN ('Mandato', 'Arrendamiento')),
    FECHA_INICIO_ORIGINAL TIMESTAMP NOT NULL,
    FECHA_FIN_ORIGINAL TIMESTAMP NOT NULL,
    FECHA_INICIO_RENOVACION TIMESTAMP NOT NULL,
    FECHA_FIN_RENOVACION TIMESTAMP NOT NULL,
    CANON_ANTERIOR INTEGER NOT NULL,
    CANON_NUEVO INTEGER NOT NULL,
    PORCENTAJE_INCREMENTO INTEGER,
    MOTIVO_RENOVACION TEXT,
    FECHA_RENOVACION DATE DEFAULT CURRENT_DATE,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY TEXT,
    FOREIGN KEY (ID_CONTRATO_M) REFERENCES CONTRATOS_MANDATOS(ID_CONTRATO_M),
    FOREIGN KEY (ID_CONTRATO_A) REFERENCES CONTRATOS_ARRENDAMIENTOS(ID_CONTRATO_A),
    CHECK((ID_CONTRATO_M IS NOT NULL AND ID_CONTRATO_A IS NULL) OR (ID_CONTRATO_M IS NULL AND ID_CONTRATO_A IS NOT NULL))
);

-- Tabla RECAUDO_ARRENDAMIENTO
CREATE TABLE RECAUDO_ARRENDAMIENTO (
    ID_RECAUDO SERIAL PRIMARY KEY,
    ID_CONTRATO_A INTEGER NOT NULL,
    VALOR_RECAUDO INTEGER NOT NULL CHECK(VALOR_RECAUDO > 0),
    FECHA_RECAUDO TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FECHA_VENCIMIENTO_RECAUDO TIMESTAMP NOT NULL,
    MEDIO_PAGO TEXT NOT NULL CHECK(MEDIO_PAGO IN ('Transferencia', 'Efectivo', 'Cheque', 'Consignaci├│n', 'PSE')),
    REFERENCIA_RECAUDO TEXT UNIQUE,
    PERIODO_RECAUDO TEXT NOT NULL,
    DIRECCION_CONTRATO_A TEXT,
    ESTADO_RECAUDO TEXT DEFAULT 'Pendiente' CHECK(ESTADO_RECAUDO IN ('Pendiente', 'Pagado', 'Mora', 'Anulado')),
    DIAS_MORA INTEGER DEFAULT 0 CHECK(DIAS_MORA >= 0),
    MOTIVO_ANULACION TEXT,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY TEXT,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_BY TEXT,
    FOREIGN KEY (ID_CONTRATO_A) REFERENCES CONTRATOS_ARRENDAMIENTOS(ID_CONTRATO_A)
);

-- Tabla INCIDENTES
CREATE TABLE INCIDENTES (
    ID_INCIDENTE SERIAL PRIMARY KEY,
    ID_PROPIEDAD INTEGER NOT NULL,
    ID_CONTRATO_M INTEGER,
    DESCRIPCION_INCIDENTE TEXT NOT NULL,
    COSTO_INCIDENTE INTEGER DEFAULT 0 CHECK(COSTO_INCIDENTE >= 0),
    FECHA_INCIDENTE TIMESTAMP NOT NULL,
    QUIEN_ARREGLA TEXT,
    APROBADO_POR TEXT,
    FECHA_ARREGLO TIMESTAMP,
    ESTADO TEXT DEFAULT 'Pendiente' CHECK(ESTADO IN ('Pendiente', 'En Proceso', 'Resuelto', 'Cancelado')),
    DIAS_SIN_RESOLVER INTEGER DEFAULT 0,
    MOTIVO_CANCELACION TEXT,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY TEXT,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_BY TEXT,
    FOREIGN KEY (ID_PROPIEDAD) REFERENCES PROPIEDADES(ID_PROPIEDAD),
    FOREIGN KEY (ID_CONTRATO_M) REFERENCES CONTRATOS_MANDATOS(ID_CONTRATO_M)
);

-- Tabla RECIBOS_PUBLICOS
CREATE TABLE RECIBOS_PUBLICOS (
    ID_RECIBO_PUBLICO SERIAL PRIMARY KEY,
    ID_PROPIEDAD INTEGER NOT NULL,
    PERIODO_RECIBO TEXT NOT NULL,
    TIPO_SERVICIO TEXT NOT NULL CHECK(TIPO_SERVICIO IN ('Agua', 'Luz', 'Gas', 'Internet', 'Tel├®fono', 'Aseo', 'Otros')),
    VALOR_RECIBO INTEGER NOT NULL CHECK(VALOR_RECIBO >= 0),
    FECHA_VENCIMIENTO TIMESTAMP,
    FECHA_PAGO TIMESTAMP,
    COMPROBANTE TEXT,
    ESTADO TEXT DEFAULT 'Pendiente' CHECK(ESTADO IN ('Pendiente', 'Pagado', 'Vencido')),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY TEXT,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_BY TEXT,
    FOREIGN KEY (ID_PROPIEDAD) REFERENCES PROPIEDADES(ID_PROPIEDAD),
    UNIQUE(ID_PROPIEDAD, PERIODO_RECIBO, TIPO_SERVICIO)
);

-- Tabla LIQUIDACIONES_PROPIETARIOS
CREATE TABLE LIQUIDACIONES_PROPIETARIOS (
    ID_LIQUIDACION_PROPIETARIO SERIAL PRIMARY KEY,
    ID_CONTRATO_M INTEGER NOT NULL,
    ID_PROPIETARIO INTEGER NOT NULL,
    PERIODO_LIQUIDACION TEXT NOT NULL,
    FECHA_VENCIMIENTO_PAGO TIMESTAMP NOT NULL,
    CANON_MANDATO_LIQUIDADO INTEGER NOT NULL CHECK(CANON_MANDATO_LIQUIDADO > 0),
    COMISION_ASESOR INTEGER NOT NULL CHECK(COMISION_ASESOR >= 0),
    COMISION_SEGURO INTEGER NOT NULL CHECK(COMISION_SEGURO >= 0),
    IVA_COMISION INTEGER NOT NULL CHECK(IVA_COMISION >= 0),
    VALOR_INCIDENTES INTEGER DEFAULT 0 CHECK(VALOR_INCIDENTES >= 0),
    IMPUESTO_4X1000 INTEGER NOT NULL CHECK(IMPUESTO_4X1000 >= 0),
    VALOR_ADMINISTRACION INTEGER DEFAULT 0 CHECK(VALOR_ADMINISTRACION >= 0),
    VALOR_RECIBOS_PUBLICOS INTEGER DEFAULT 0 CHECK(VALOR_RECIBOS_PUBLICOS >= 0),
    TOTAL_DESCUENTOS INTEGER NOT NULL CHECK(TOTAL_DESCUENTOS >= 0),
    VALOR_NETO_PROPIETARIO INTEGER NOT NULL,
    ESTADO_LIQUIDACION TEXT DEFAULT 'Pendiente' CHECK(ESTADO_LIQUIDACION IN ('Pendiente', 'Aprobada', 'Pagada', 'Mora', 'Anulada')),
    DIAS_MORA INTEGER DEFAULT 0 CHECK(DIAS_MORA >= 0),
    FECHA_CREACION TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FECHA_APROBACION TIMESTAMP,
    USUARIO_CREADOR TEXT,
    USUARIO_APROBADOR TEXT,
    OBSERVACIONES_LIQUIDACION TEXT,
    MOTIVO_ANULACION TEXT,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY TEXT,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_BY TEXT,
    FOREIGN KEY (ID_CONTRATO_M) REFERENCES CONTRATOS_MANDATOS(ID_CONTRATO_M),
    FOREIGN KEY (ID_PROPIETARIO) REFERENCES PROPIETARIOS(ID_PROPIETARIO),
    UNIQUE(ID_CONTRATO_M, PERIODO_LIQUIDACION)
);

-- Tabla LIQUIDACIONES_ASESORES
CREATE TABLE LIQUIDACIONES_ASESORES (
    ID_LIQUIDACION_ASESOR SERIAL PRIMARY KEY,
    ID_CONTRATO_A INTEGER NOT NULL,
    ID_ASESOR INTEGER NOT NULL,
    PERIODO_LIQUIDACION TEXT NOT NULL,
    CANON_ARRENDAMIENTO_LIQUIDADO INTEGER NOT NULL CHECK(CANON_ARRENDAMIENTO_LIQUIDADO > 0),
    PORCENTAJE_COMISION INTEGER NOT NULL CHECK(PORCENTAJE_COMISION >= 0 AND PORCENTAJE_COMISION <= 10000),
    COMISION_BRUTA INTEGER NOT NULL CHECK(COMISION_BRUTA >= 0),
    TOTAL_DESCUENTOS INTEGER DEFAULT 0 CHECK(TOTAL_DESCUENTOS >= 0),
    VALOR_NETO_ASESOR INTEGER NOT NULL,
    ESTADO_LIQUIDACION TEXT DEFAULT 'Pendiente' CHECK(ESTADO_LIQUIDACION IN ('Pendiente', 'Aprobada', 'Pagada', 'Anulada')),
    FECHA_CREACION TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FECHA_APROBACION TIMESTAMP,
    USUARIO_CREADOR TEXT,
    USUARIO_APROBADOR TEXT,
    OBSERVACIONES_LIQUIDACION TEXT,
    MOTIVO_ANULACION TEXT,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY TEXT,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_BY TEXT,
    FOREIGN KEY (ID_CONTRATO_A) REFERENCES CONTRATOS_ARRENDAMIENTOS(ID_CONTRATO_A),
    FOREIGN KEY (ID_ASESOR) REFERENCES ASESORES(ID_ASESOR),
    UNIQUE(ID_CONTRATO_A, PERIODO_LIQUIDACION)
);

-- Tabla DESCUENTOS_ASESORES
CREATE TABLE DESCUENTOS_ASESORES (
    ID_DESCUENTO_ASESOR SERIAL PRIMARY KEY,
    ID_LIQUIDACION_ASESOR INTEGER NOT NULL,
    TIPO_DESCUENTO TEXT NOT NULL CHECK(TIPO_DESCUENTO IN ('Préstamo', 'Anticipo', 'Sanción', 'Ajuste', 'Otros')),
    DESCRIPCION_DESCUENTO TEXT NOT NULL,
    VALOR_DESCUENTO INTEGER NOT NULL CHECK(VALOR_DESCUENTO >= 0),
    FECHA_REGISTRO TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY TEXT,
    FOREIGN KEY (ID_LIQUIDACION_ASESOR) REFERENCES LIQUIDACIONES_ASESORES(ID_LIQUIDACION_ASESOR)
);

-- Tabla SALDOS_FAVOR
CREATE TABLE SALDOS_FAVOR (
    ID_SALDO_FAVOR SERIAL PRIMARY KEY,
    ID_PROPIETARIO INTEGER,
    ID_ASESOR INTEGER,
    TIPO_BENEFICIARIO TEXT NOT NULL CHECK(TIPO_BENEFICIARIO IN ('Propietario', 'Asesor')),
    VALOR_SALDO INTEGER NOT NULL CHECK(VALOR_SALDO > 0),
    MOTIVO TEXT NOT NULL,
    FECHA_GENERACION DATE DEFAULT CURRENT_DATE,
    ESTADO TEXT DEFAULT 'Pendiente' CHECK(ESTADO IN ('Pendiente', 'Aplicado', 'Devuelto')),
    FECHA_RESOLUCION TIMESTAMP,
    OBSERVACIONES TEXT,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY TEXT,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_BY TEXT,
    FOREIGN KEY (ID_PROPIETARIO) REFERENCES PROPIETARIOS(ID_PROPIETARIO),
    FOREIGN KEY (ID_ASESOR) REFERENCES ASESORES(ID_ASESOR),
    CHECK((ID_PROPIETARIO IS NOT NULL AND ID_ASESOR IS NULL) OR (ID_PROPIETARIO IS NULL AND ID_ASESOR IS NOT NULL))
);

-- Tabla PAGOS_PROPIETARIOS
CREATE TABLE PAGOS_PROPIETARIOS (
    ID_PAGO_PROPIETARIO SERIAL PRIMARY KEY,
    ID_LIQUIDACION_PROPIETARIO INTEGER NOT NULL,
    ID_PROPIETARIO INTEGER NOT NULL,
    VALOR_PAGO INTEGER NOT NULL CHECK(VALOR_PAGO > 0),
    FECHA_PAGO TIMESTAMP,
    FECHA_PROGRAMADA TIMESTAMP NOT NULL,
    MEDIO_PAGO TEXT CHECK(MEDIO_PAGO IN ('Transferencia', 'Cheque', 'Efectivo', 'PSE')),
    REFERENCIA_PAGO TEXT UNIQUE,
    BANCO_DESTINO TEXT,
    CUENTA_DESTINO TEXT,
    TIPO_CUENTA_DESTINO TEXT CHECK(TIPO_CUENTA_DESTINO IN ('Ahorros', 'Corriente')),
    ESTADO_PAGO TEXT DEFAULT 'Pendiente' CHECK(ESTADO_PAGO IN ('Pendiente', 'Programado', 'Pagado', 'Rechazado', 'Anulado')),
    MOTIVO_RECHAZO TEXT,
    COMPROBANTE_PAGO TEXT,
    OBSERVACIONES_PAGO TEXT,
    FECHA_CONFIRMACION TIMESTAMP,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY TEXT,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_BY TEXT,
    FOREIGN KEY (ID_LIQUIDACION_PROPIETARIO) REFERENCES LIQUIDACIONES_PROPIETARIOS(ID_LIQUIDACION_PROPIETARIO),
    FOREIGN KEY (ID_PROPIETARIO) REFERENCES PROPIETARIOS(ID_PROPIETARIO)
);

-- Tabla PAGOS_ASESORES
CREATE TABLE PAGOS_ASESORES (
    ID_PAGO_ASESOR SERIAL PRIMARY KEY,
    ID_LIQUIDACION_ASESOR INTEGER NOT NULL,
    ID_ASESOR INTEGER NOT NULL,
    VALOR_PAGO INTEGER NOT NULL CHECK(VALOR_PAGO > 0),
    FECHA_PAGO TIMESTAMP,
    FECHA_PROGRAMADA TIMESTAMP NOT NULL,
    MEDIO_PAGO TEXT CHECK(MEDIO_PAGO IN ('Transferencia', 'Cheque', 'Efectivo', 'PSE')),
    REFERENCIA_PAGO TEXT UNIQUE,
    ESTADO_PAGO TEXT DEFAULT 'Pendiente' CHECK(ESTADO_PAGO IN ('Pendiente', 'Programado', 'Pagado', 'Rechazado', 'Anulado')),
    MOTIVO_RECHAZO TEXT,
    COMPROBANTE_PAGO TEXT,
    OBSERVACIONES_PAGO TEXT,
    FECHA_CONFIRMACION TIMESTAMP,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY TEXT,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_BY TEXT,
    FOREIGN KEY (ID_LIQUIDACION_ASESOR) REFERENCES LIQUIDACIONES_ASESORES(ID_LIQUIDACION_ASESOR),
    FOREIGN KEY (ID_ASESOR) REFERENCES ASESORES(ID_ASESOR)
);

-- Tabla ALERTAS
CREATE TABLE ALERTAS (
    ID_ALERTAS SERIAL PRIMARY KEY,
    TIPO_ALERTA TEXT NOT NULL CHECK(TIPO_ALERTA IN (
        'Vencimiento Contrato Mandato',
        'Vencimiento Contrato Arrendamiento',
        'Incremento IPC',
        'Mora Recaudo',
        'Mora Liquidación',
        'Incidente Sin Resolver',
        'Liquidación Pendiente Aprobación',
        'Asesor Sin Actividad',
        'Propietario Múltiples Moras',
        'Pago Rechazado',
        'Otros'
    )),
    DESCRIPCION_ALERTA TEXT NOT NULL,
    PRIORIDAD TEXT CHECK(PRIORIDAD IN ('Alta', 'Media', 'Baja')) DEFAULT 'Media',
    FECHA_GENERACION_ALERTA TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FECHA_VENCIMIENTO_ALERTA TIMESTAMP,
    ESTADO_ALERTA TEXT DEFAULT 'Pendiente' CHECK(ESTADO_ALERTA IN ('Pendiente', 'En Proceso', 'Resuelta', 'Archivada')),
    ID_ENTIDAD_RELACIONADA INTEGER,
    TIPO_ENTIDAD TEXT,
    USUARIO_ASIGNADO TEXT,
    ACCION_TOMADA TEXT,
    FECHA_ACCION TIMESTAMP,
    PLANTILLA_MENSAJE TEXT,
    DESTINATARIO_NOMBRE TEXT,
    DESTINATARIO_TELEFONO TEXT,
    DESTINATARIO_EMAIL TEXT,
    FECHA_RESOLUCION TIMESTAMP,
    RESUELTO_AUTOMATICAMENTE INTEGER DEFAULT 0 CHECK(RESUELTO_AUTOMATICAMENTE IN (0, 1)),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY TEXT
);

-- Tabla NOTIFICACIONES_ENVIADAS
CREATE TABLE NOTIFICACIONES_ENVIADAS (
    ID_NOTIFICACION SERIAL PRIMARY KEY,
    ID_ALERTA INTEGER,
    TIPO_NOTIFICACION TEXT NOT NULL CHECK(TIPO_NOTIFICACION IN ('WhatsApp', 'Email', 'Sistema', 'SMS')),
    DESTINATARIO TEXT NOT NULL,
    ASUNTO TEXT,
    MENSAJE TEXT NOT NULL,
    FECHA_ENVIO TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ESTADO_ENVIO TEXT DEFAULT 'Pendiente' CHECK(ESTADO_ENVIO IN ('Pendiente', 'Enviado', 'Fallido', 'Entregado')),
    RESPUESTA_SISTEMA TEXT,
    INTENTOS_ENVIO INTEGER DEFAULT 1,
    FECHA_ENTREGA TIMESTAMP,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY TEXT,
    FOREIGN KEY (ID_ALERTA) REFERENCES ALERTAS(ID_ALERTAS)
);

-- Tabla PLANTILLAS_NOTIFICACIONES
CREATE TABLE PLANTILLAS_NOTIFICACIONES (
    ID_PLANTILLA SERIAL PRIMARY KEY,
    TIPO_ALERTA TEXT NOT NULL,
    CANAL TEXT NOT NULL CHECK(CANAL IN ('WhatsApp', 'Email', 'Sistema')),
    ASUNTO TEXT,
    MENSAJE_PLANTILLA TEXT NOT NULL,
    VARIABLES_DISPONIBLES TEXT,
    ESTADO INTEGER DEFAULT 1 CHECK(ESTADO IN (0, 1)),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY TEXT,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_BY TEXT,
    UNIQUE(TIPO_ALERTA, CANAL)
);

-- Tabla ARCHIVOS_ADJUNTOS
CREATE TABLE ARCHIVOS_ADJUNTOS (
    ID_ARCHIVO SERIAL PRIMARY KEY,
    ID_ENTIDAD_RELACIONADA INTEGER NOT NULL,
    TIPO_ENTIDAD TEXT NOT NULL CHECK(TIPO_ENTIDAD IN (
        'PROPIEDAD',
        'CONTRATO_MANDATO',
        'CONTRATO_ARRENDAMIENTO',
        'PAGO_PROPIETARIO',
        'PAGO_ASESOR',
        'INCIDENTE',
        'RECIBO_PUBLICO',
        'LIQUIDACION_PROPIETARIO',
        'LIQUIDACION_ASESOR'
    )),
    TIPO_ARCHIVO TEXT NOT NULL CHECK(TIPO_ARCHIVO IN (
        'Foto Propiedad',
        'Escritura',
        'Certificado Tradición',
        'Contrato Firmado',
        'Documento Identidad',
        'Comprobante Pago',
        'Foto Incidente',
        'Cotización',
        'Factura',
        'Recibo Público',
        'Otros'
    )),
    NOMBRE_ARCHIVO TEXT NOT NULL,
    URL_ONEDRIVE TEXT NOT NULL,
    TAMAÑO_KB INTEGER,
    EXTENSION TEXT,
    DESCRIPCION TEXT,
    VERSION INTEGER DEFAULT 1,
    ESTADO INTEGER DEFAULT 1 CHECK(ESTADO IN (0, 1)),
    FECHA_CARGA TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY TEXT
);

-- Tabla AUDITORIA_CAMBIOS
CREATE TABLE AUDITORIA_CAMBIOS (
    ID_AUDITORIA SERIAL PRIMARY KEY,
    TABLA TEXT NOT NULL,
    ID_REGISTRO INTEGER NOT NULL,
    TIPO_OPERACION TEXT NOT NULL CHECK(TIPO_OPERACION IN ('INSERT', 'UPDATE', 'DELETE', 'ESTADO_CHANGE')),
    CAMPO_MODIFICADO TEXT,
    VALOR_ANTERIOR TEXT,
    VALOR_NUEVO TEXT,
    USUARIO TEXT NOT NULL,
    FECHA_CAMBIO TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    MOTIVO_CAMBIO TEXT,
    IP_ORIGEN TEXT
);

-- Tabla HISTORIAL_ESTADOS
CREATE TABLE HISTORIAL_ESTADOS (
    ID_HISTORIAL SERIAL PRIMARY KEY,
    TIPO_ENTIDAD TEXT NOT NULL CHECK(TIPO_ENTIDAD IN (
        'CONTRATO_MANDATO',
        'CONTRATO_ARRENDAMIENTO',
        'LIQUIDACION_PROPIETARIO',
        'LIQUIDACION_ASESOR',
        'PAGO_PROPIETARIO',
        'PAGO_ASESOR',
        'RECAUDO',
        'INCIDENTE',
        'ALERTA'
    )),
    ID_ENTIDAD INTEGER NOT NULL,
    ESTADO_ANTERIOR TEXT NOT NULL,
    ESTADO_NUEVO TEXT NOT NULL,
    MOTIVO_CAMBIO TEXT,
    FECHA_CAMBIO TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    USUARIO TEXT NOT NULL,
    REQUIRIO_APROBACION INTEGER DEFAULT 0 CHECK(REQUIRIO_APROBACION IN (0, 1)),
    APROBADO_POR TEXT
);

-- Tabla PARAMETROS_SISTEMA
CREATE TABLE PARAMETROS_SISTEMA (
    ID_PARAMETRO SERIAL PRIMARY KEY,
    NOMBRE_PARAMETRO TEXT NOT NULL UNIQUE,
    VALOR_PARAMETRO TEXT NOT NULL,
    TIPO_DATO TEXT CHECK(TIPO_DATO IN ('INTEGER', 'TEXT', 'DECIMAL', 'BOOLEAN')),
    DESCRIPCION TEXT,
    CATEGORIA TEXT,
    MODIFICABLE INTEGER DEFAULT 1 CHECK(MODIFICABLE IN (0, 1)),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_BY TEXT
);

-- Tabla CONTRATOS_MANDATOS
CREATE TABLE CONTRATOS_MANDATOS (
    ID_CONTRATO_M SERIAL PRIMARY KEY,
    ID_PROPIEDAD INTEGER NOT NULL,
    ID_PROPIETARIO INTEGER NOT NULL,
    ID_ASESOR INTEGER NOT NULL,
    FECHA_INICIO_CONTRATO_M TIMESTAMP NOT NULL,
    FECHA_FIN_CONTRATO_M TIMESTAMP NOT NULL,
    DURACION_CONTRATO_M INTEGER NOT NULL CHECK(DURACION_CONTRATO_M > 0),
    CANON_MANDATO INTEGER NOT NULL CHECK(CANON_MANDATO >= 500000 AND CANON_MANDATO <= 200000000),
    COMISION_PORCENTAJE_CONTRATO_M INTEGER NOT NULL CHECK(COMISION_PORCENTAJE_CONTRATO_M >= 0 AND COMISION_PORCENTAJE_CONTRATO_M <= 10000),
    IVA_CONTRATO_M INTEGER DEFAULT 1900 CHECK(IVA_CONTRATO_M >= 0),
    ESTADO_CONTRATO_M TEXT CHECK(ESTADO_CONTRATO_M IN ('Activo', 'Finalizado', 'Cancelado')) DEFAULT 'Activo',
    MOTIVO_CANCELACION TEXT,
    ALERTA_VENCIMIENTO_CONTRATO_M INTEGER DEFAULT 1 CHECK(ALERTA_VENCIMIENTO_CONTRATO_M IN (0, 1)),
    FECHA_RENOVACION_CONTRATO_M TIMESTAMP,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY TEXT,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_BY TEXT,
    CHECK(FECHA_FIN_CONTRATO_M > FECHA_INICIO_CONTRATO_M),
    FOREIGN KEY (ID_PROPIEDAD) REFERENCES PROPIEDADES(ID_PROPIEDAD),
    FOREIGN KEY (ID_PROPIETARIO) REFERENCES PROPIETARIOS(ID_PROPIETARIO),
    FOREIGN KEY (ID_ASESOR) REFERENCES ASESORES(ID_ASESOR)
);

-- Tabla CONTRATOS_ARRENDAMIENTOS
CREATE TABLE CONTRATOS_ARRENDAMIENTOS (
    ID_CONTRATO_A SERIAL PRIMARY KEY,
    ID_PROPIEDAD INTEGER NOT NULL,
    ID_ARRENDATARIO INTEGER NOT NULL,
    ID_CODEUDOR INTEGER,
    FECHA_INICIO_CONTRATO_A TIMESTAMP NOT NULL,
    FECHA_FIN_CONTRATO_A TIMESTAMP NOT NULL,
    DURACION_CONTRATO_A INTEGER NOT NULL CHECK(DURACION_CONTRATO_A > 0),
    CANON_ARRENDAMIENTO INTEGER NOT NULL CHECK(CANON_ARRENDAMIENTO >= 500000 AND CANON_ARRENDAMIENTO <= 200000000),
    DEPOSITO INTEGER DEFAULT 0 CHECK(DEPOSITO >= 0),
    ESTADO_CONTRATO_A TEXT CHECK(ESTADO_CONTRATO_A IN ('Activo', 'Finalizado', 'Legal', 'Cancelado')) DEFAULT 'Activo',
    MOTIVO_CANCELACION TEXT,
    ALERTA_VENCIMIENTO_CONTRATO_A INTEGER DEFAULT 1 CHECK(ALERTA_VENCIMIENTO_CONTRATO_A IN (0, 1)),
    ALERTA_IPC INTEGER DEFAULT 0 CHECK(ALERTA_IPC IN (0, 1)),
    FECHA_RENOVACION_CONTRATO_A TIMESTAMP,
    FECHA_INCREMENTO_IPC TIMESTAMP,
    FECHA_ULTIMO_INCREMENTO_IPC TIMESTAMP,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY TEXT,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_BY TEXT,
    CHECK(FECHA_FIN_CONTRATO_A > FECHA_INICIO_CONTRATO_A),
    FOREIGN KEY (ID_PROPIEDAD) REFERENCES PROPIEDADES(ID_PROPIEDAD),
    FOREIGN KEY (ID_ARRENDATARIO) REFERENCES ARRENDATARIOS(ID_ARRENDATARIO),
    FOREIGN KEY (ID_CODEUDOR) REFERENCES CODEUDORES(ID_CODEUDOR)
);

-- Tabla CONTRATOS_ARRENDAMIENTOS_OLD (backup, opcional)
CREATE TABLE CONTRATOS_ARRENDAMIENTOS_OLD (
    ID_CONTRATO_A INTEGER,
    ID_PROPIEDAD INTEGER,
    ID_ARRENDATARIO INTEGER,
    ID_CODEUDOR INTEGER,
    FECHA_INICIO_CONTRATO_A TIMESTAMP,
    FECHA_FIN_CONTRATO_A TIMESTAMP,
    DURACION_CONTRATO_A INTEGER,
    CANON_ARRENDAMIENTO INTEGER,
    DEPOSITO INTEGER,
    ESTADO_CONTRATO_A TEXT,
    MOTIVO_CANCELACION TEXT,
    ALERTA_VENCIMIENTO_CONTRATO_A INTEGER,
    ALERTA_IPC INTEGER,
    FECHA_RENOVACION_CONTRATO_A TIMESTAMP,
    FECHA_INCREMENTO_IPC TIMESTAMP,
    FECHA_ULTIMO_INCREMENTO_IPC TIMESTAMP,
    CREATED_AT TIMESTAMP,
    CREATED_BY TEXT,
    UPDATED_AT TIMESTAMP,
    UPDATED_BY TEXT
);

-- Índices
CREATE INDEX idx_personas_documento ON PERSONAS(TIPO_DOCUMENTO, NUMERO_DOCUMENTO);
CREATE INDEX idx_personas_estado ON PERSONAS(ESTADO_REGISTRO);
CREATE INDEX idx_propiedades_disponibilidad ON PROPIEDADES(DISPONIBILIDAD_PROPIEDAD);
CREATE INDEX idx_propiedades_municipio ON PROPIEDADES(ID_MUNICIPIO, ESTADO_REGISTRO);
CREATE INDEX idx_propiedades_estado ON PROPIEDADES(ESTADO_REGISTRO);
CREATE INDEX idx_liquidaciones_propietarios_periodo ON LIQUIDACIONES_PROPIETARIOS(PERIODO_LIQUIDACION);
CREATE INDEX idx_liquidaciones_propietarios_estado ON LIQUIDACIONES_PROPIETARIOS(ESTADO_LIQUIDACION);
CREATE INDEX idx_liquidaciones_propietarios_propietario ON LIQUIDACIONES_PROPIETARIOS(ID_PROPIETARIO, ESTADO_LIQUIDACION);
CREATE INDEX idx_liquidaciones_propietarios_mora ON LIQUIDACIONES_PROPIETARIOS(ESTADO_LIQUIDACION, DIAS_MORA) WHERE ESTADO_LIQUIDACION = 'Mora';
CREATE INDEX idx_liquidaciones_asesores_periodo ON LIQUIDACIONES_ASESORES(PERIODO_LIQUIDACION);
CREATE INDEX idx_liquidaciones_asesores_estado ON LIQUIDACIONES_ASESORES(ESTADO_LIQUIDACION);
CREATE INDEX idx_liquidaciones_asesores_asesor ON LIQUIDACIONES_ASESORES(ID_ASESOR, ESTADO_LIQUIDACION);
CREATE INDEX idx_pagos_propietarios_estado ON PAGOS_PROPIETARIOS(ESTADO_PAGO);
CREATE INDEX idx_pagos_propietarios_fecha ON PAGOS_PROPIETARIOS(FECHA_PROGRAMADA, ESTADO_PAGO);
CREATE INDEX idx_pagos_asesores_estado ON PAGOS_ASESORES(ESTADO_PAGO);
CREATE INDEX idx_pagos_asesores_fecha ON PAGOS_ASESORES(FECHA_PROGRAMADA, ESTADO_PAGO);
CREATE INDEX idx_recaudo_periodo ON RECAUDO_ARRENDAMIENTO(PERIODO_RECAUDO);
CREATE INDEX idx_recaudo_estado ON RECAUDO_ARRENDAMIENTO(ESTADO_RECAUDO);
CREATE INDEX idx_recaudo_mora ON RECAUDO_ARRENDAMIENTO(ESTADO_RECAUDO, DIAS_MORA) WHERE ESTADO_RECAUDO = 'Mora';
CREATE INDEX idx_recaudo_contrato ON RECAUDO_ARRENDAMIENTO(ID_CONTRATO_A, PERIODO_RECAUDO);
CREATE INDEX idx_incidentes_fecha ON INCIDENTES(ID_PROPIEDAD, FECHA_INCIDENTE);
CREATE INDEX idx_incidentes_estado ON INCIDENTES(ESTADO);
CREATE INDEX idx_incidentes_pendientes ON INCIDENTES(ESTADO, DIAS_SIN_RESOLVER) WHERE ESTADO = 'Pendiente';
CREATE INDEX idx_recibos_publicos_periodo ON RECIBOS_PUBLICOS(PERIODO_RECIBO);
CREATE INDEX idx_recibos_publicos_propiedad ON RECIBOS_PUBLICOS(ID_PROPIEDAD, PERIODO_RECIBO);
CREATE INDEX idx_recibos_publicos_estado ON RECIBOS_PUBLICOS(ESTADO);
CREATE INDEX idx_alertas_estado ON ALERTAS(ESTADO_ALERTA);
CREATE INDEX idx_alertas_tipo ON ALERTAS(TIPO_ALERTA, ESTADO_ALERTA);
CREATE INDEX idx_alertas_entidad ON ALERTAS(TIPO_ENTIDAD, ID_ENTIDAD_RELACIONADA);
CREATE INDEX idx_alertas_prioridad ON ALERTAS(PRIORIDAD, ESTADO_ALERTA);
CREATE INDEX idx_alertas_usuario ON ALERTAS(USUARIO_ASIGNADO, ESTADO_ALERTA);
CREATE INDEX idx_notificaciones_estado ON NOTIFICACIONES_ENVIADAS(ESTADO_ENVIO);
CREATE INDEX idx_notificaciones_fecha ON NOTIFICACIONES_ENVIADAS(FECHA_ENVIO);
CREATE INDEX idx_notificaciones_alerta ON NOTIFICACIONES_ENVIADAS(ID_ALERTA);
CREATE INDEX idx_archivos_entidad ON ARCHIVOS_ADJUNTOS(TIPO_ENTIDAD, ID_ENTIDAD_RELACIONADA);
CREATE INDEX idx_archivos_tipo ON ARCHIVOS_ADJUNTOS(TIPO_ARCHIVO, ESTADO);
CREATE INDEX idx_auditoria_tabla ON AUDITORIA_CAMBIOS(TABLA, ID_REGISTRO);
CREATE INDEX idx_auditoria_usuario ON AUDITORIA_CAMBIOS(USUARIO, FECHA_CAMBIO);
CREATE INDEX idx_auditoria_fecha ON AUDITORIA_CAMBIOS(FECHA_CAMBIO);
CREATE INDEX idx_historial_entidad ON HISTORIAL_ESTADOS(TIPO_ENTIDAD, ID_ENTIDAD);
CREATE INDEX idx_historial_fecha ON HISTORIAL_ESTADOS(FECHA_CAMBIO);
CREATE INDEX idx_usuarios_rol ON USUARIOS(ROL, ESTADO_USUARIO);
CREATE INDEX idx_sesiones_usuario ON SESIONES_USUARIO(ID_USUARIO, FECHA_INICIO);
CREATE UNIQUE INDEX idx_mandato_activo ON CONTRATOS_MANDATOS(ID_PROPIEDAD) WHERE ESTADO_CONTRATO_M = 'Activo';
CREATE UNIQUE INDEX idx_arriendo_activo ON CONTRATOS_ARRENDAMIENTOS(ID_PROPIEDAD) WHERE ESTADO_CONTRATO_A = 'Activo';

-- Triggers
CREATE OR REPLACE FUNCTION trg_prevenir_delete_contratos() RETURNS TRIGGER AS $$
BEGIN
    RAISE EXCEPTION 'Error: No está permitido eliminar contratos físicamente. Debe cambiar su estado a "Cancelado" o "Finalizado" para mantener el histórico.';
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_prevenir_delete_contratos BEFORE DELETE ON CONTRATOS_ARRENDAMIENTOS FOR EACH ROW EXECUTE FUNCTION trg_prevenir_delete_contratos();

CREATE OR REPLACE FUNCTION trg_validar_fechas_contrato() RETURNS TRIGGER AS $$
BEGIN
    IF NEW.FECHA_FIN_CONTRATO_A <= NEW.FECHA_INICIO_CONTRATO_A THEN
        RAISE EXCEPTION 'Error: La fecha de finalización no puede ser anterior a la fecha de inicio.';
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_validar_fechas_contrato BEFORE INSERT ON CONTRATOS_ARRENDAMIENTOS FOR EACH ROW EXECUTE FUNCTION trg_validar_fechas_contrato();

CREATE OR REPLACE FUNCTION trg_evitar_solapamiento_arriendo() RETURNS TRIGGER AS $$
BEGIN
    IF EXISTS (
        SELECT 1 FROM CONTRATOS_ARRENDAMIENTOS 
        WHERE ID_PROPIEDAD = NEW.ID_PROPIEDAD 
        AND ESTADO_CONTRATO_A = 'Activo'
    ) THEN
        RAISE EXCEPTION 'Error: Esta propiedad ya tiene un contrato de arrendamiento ACTIVO. Debe finalizar el anterior primero.';
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_evitar_solapamiento_arriendo BEFORE INSERT ON CONTRATOS_ARRENDAMIENTOS FOR EACH ROW EXECUTE FUNCTION trg_evitar_solapamiento_arriendo();

CREATE OR REPLACE FUNCTION trg_evitar_solapamiento_mandato() RETURNS TRIGGER AS $$
BEGIN
    IF EXISTS (
        SELECT 1 FROM CONTRATOS_MANDATOS 
        WHERE ID_PROPIEDAD = NEW.ID_PROPIEDAD 
        AND ESTADO_CONTRATO_M = 'Activo'
    ) THEN
        RAISE EXCEPTION 'Error: Esta propiedad ya tiene un contrato de mandato ACTIVO.';
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_evitar_solapamiento_mandato BEFORE INSERT ON CONTRATOS_MANDATOS FOR EACH ROW EXECUTE FUNCTION trg_evitar_solapamiento_mandato();

CREATE OR REPLACE FUNCTION trg_exigir_motivo_cancelacion() RETURNS TRIGGER AS $$
BEGIN
    IF NEW.ESTADO_CONTRATO_A = 'Cancelado' AND (NEW.MOTIVO_CANCELACION IS NULL OR NEW.MOTIVO_CANCELACION = '') THEN
        RAISE EXCEPTION 'Error: Para cancelar un contrato es OBLIGATORIO ingresar un motivo de cancelación.';
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_exigir_motivo_cancelacion BEFORE UPDATE ON CONTRATOS_ARRENDAMIENTOS FOR EACH ROW EXECUTE FUNCTION trg_exigir_motivo_cancelacion();

CREATE OR REPLACE FUNCTION trg_actualizar_disponibilidad_ocupada() RETURNS TRIGGER AS $$
BEGIN
    IF NEW.ESTADO_CONTRATO_A = 'Activo' THEN
        UPDATE PROPIEDADES 
        SET DISPONIBILIDAD_PROPIEDAD = 0,
            UPDATED_BY = NEW.CREATED_BY,
            UPDATED_AT = CURRENT_TIMESTAMP
        WHERE ID_PROPIEDAD = NEW.ID_PROPIEDAD;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_actualizar_disponibilidad_ocupada AFTER INSERT ON CONTRATOS_ARRENDAMIENTOS FOR EACH ROW EXECUTE FUNCTION trg_actualizar_disponibilidad_ocupada();

-- Vistas
CREATE VIEW VW_ALERTA_MORA_DIARIA AS
SELECT 
    r.ID_RECAUDO,
    ca.ID_CONTRATO_A,
    p.DIRECCION_PROPIEDAD,
    arr_p.NOMBRE_COMPLETO AS ARRENDATARIO,
    arr_p.TELEFONO_PRINCIPAL,
    r.VALOR_RECAUDO,
    r.FECHA_VENCIMIENTO_RECAUDO,
    CURRENT_DATE AS FECHA_HOY,
    EXTRACT(DAY FROM CURRENT_DATE - r.FECHA_VENCIMIENTO_RECAUDO) AS DIAS_RETRASO
FROM RECAUDO_ARRENDAMIENTO r
JOIN CONTRATOS_ARRENDAMIENTOS ca ON r.ID_CONTRATO_A = ca.ID_CONTRATO_A
JOIN PROPIEDADES p ON ca.ID_PROPIEDAD = p.ID_PROPIEDAD
JOIN ARRENDATARIOS arr ON ca.ID_ARRENDATARIO = arr.ID_ARRENDATARIO
JOIN PERSONAS arr_p ON arr.ID_PERSONA = arr_p.ID_PERSONA
WHERE r.ESTADO_RECAUDO IN ('Pendiente', 'Mora')
AND r.FECHA_VENCIMIENTO_RECAUDO < CURRENT_DATE;

CREATE VIEW VW_ALERTA_VENCIMIENTO_CONTRATOS AS
SELECT 
    ca.ID_CONTRATO_A,
    p.DIRECCION_PROPIEDAD,
    arr_p.NOMBRE_COMPLETO AS ARRENDATARIO,
    arr_p.TELEFONO_PRINCIPAL, 
    ca.FECHA_FIN_CONTRATO_A,
    EXTRACT(DAY FROM ca.FECHA_FIN_CONTRATO_A - CURRENT_DATE) AS DIAS_RESTANTES
FROM CONTRATOS_ARRENDAMIENTOS ca
JOIN PROPIEDADES p ON ca.ID_PROPIEDAD = p.ID_PROPIEDAD
JOIN ARRENDATARIOS arr ON ca.ID_ARRENDATARIO = arr.ID_ARRENDATARIO
JOIN PERSONAS arr_p ON arr.ID_PERSONA = arr_p.ID_PERSONA
WHERE ca.ESTADO_CONTRATO_A = 'Activo'
AND ca.FECHA_FIN_CONTRATO_A <= CURRENT_DATE + INTERVAL '90 days';

CREATE VIEW VW_REPORTE_DISPONIBLES AS
SELECT 
    p.ID_PROPIEDAD,
    m.NOMBRE_MUNICIPIO AS CIUDAD,
    p.DIRECCION_PROPIEDAD,
    p.ESTRATO,
    p.CANON_ARRENDAMIENTO_ESTIMADO AS CANON,
    p.AREA_M2,
    p.HABITACIONES,
    p.BANO
FROM PROPIEDADES p
JOIN MUNICIPIOS m ON p.ID_MUNICIPIO = m.ID_MUNICIPIO
WHERE p.DISPONIBILIDAD_PROPIEDAD = 1
AND p.ESTADO_REGISTRO = 1;